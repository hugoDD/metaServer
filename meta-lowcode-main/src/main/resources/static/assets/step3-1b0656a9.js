import{R as e,r as t,v as s,p as r,l as a,Y as o,o as i,a as l,g as p,E as n,t as m,f as d,ac as u,i as c,w as j,z as f,c as v,X as h,a0 as y,G as g,F as w}from"./@vue-1ad4818c.js";import{D as b}from"./detail-5eb8c530.js";import{_ as k}from"./index-ea085229.js";import{b as x}from"./element-plus-bab58d46.js";import"./DetailTabs-e3a61e27.js";import"./DetailTabsSet-9cda58dd.js";import"./vue-draggable-next-a413f884.js";import"./lodash-es-b8e8104a.js";import"./@vueuse-477b4dbb.js";import"./@element-plus-2a6d398c.js";import"./@babel-6bd44fd1.js";import"./@popperjs-b78c3215.js";import"./@ctrl-4982d949.js";import"./dayjs-7fb79ad3.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./escape-html-3148dbc9.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-0ef99041.js";import"./vue3-manner-report-313033e6.js";import"./axios-85bcd05e.js";import"./crypto-js-43a3a23e.js";import"./cron-parser-1391a961.js";import"./luxon-b01799b6.js";import"./vue-router-414ebc36.js";import"./nprogress-c04e6182.js";import"./pinia-3f60a8e1.js";import"./sortablejs-2f5483e3.js";import"./qrcodejs2-fix-bab07f30.js";import"./moment-bafe441d.js";import"./pinyin-pro-c81f5d39.js";import"./vue-i18n-0843b5c5.js";import"./@intlify-2528d766.js";import"./source-map-b06bd4b9.js";import"./vue-c723f8b1.js";import"./pinia-plugin-persistedstate-d2bd58cf.js";import"./resize-observer-polyfill-ad543aa3.js";import"./vue-smart-widget-8b3f5b0a.js";import"./echarts-b5d24e9a.js";import"./zrender-a15b073b.js";import"./tslib-a4e99503.js";import"./echarts-liquidfill-f5c863f1.js";import"./@antv-43d380be.js";import"./ant-design-vue-2db0c9af.js";import"./@ant-design-60f2ef8e.js";import"./vue-types-6bcea8eb.js";import"./dom-align-78cb5391.js";import"./vue-resize-observer-90aea344.js";import"./More-47f7037c.js";import"./SetColumn-15f4404b.js";import"./DataExport-cabbbed3.js";import"./Allocation-359987ff.js";import"./ReportForms-7661dfe6.js";import"./DefaultFilterDialog-f7a53bd1.js";import"./FormatRow-d4305ec1.js";import"./edit-dfd0882d.js";import"./team-3e46d8bc.js";import"./NewRelated-d601bf33.js";import"./ApprovalRelated-e5fb019d.js";import"./CardLayout-74c0bddb.js";const _={class:"import-trace"},C={class:"import-content"},T={class:"title"},D={class:"fl title-left"},I={key:0},z={key:1},M={key:2},E={class:"fl title-right"},R={class:"import-progress"},V={class:"btn-box mt-15"},F={key:0,class:"error-span"},A={key:1,class:"skip-span"},N=["onClick"],q={class:"rt-1"},B=["onClick"],S={class:"rt-1"},G={class:"text-ellipsis"},L=k({__name:"step3",props:{modelValue:null},emits:["update:modelValue","reset"],setup(k,{emit:L}){const $=k,H=e("$ElMessage"),J=e("$API");let K=t({}),O=s({completed:0,total:0,progress:0,elapsedTime:0,interrupted:!1});r((()=>{K.value=$.modelValue,P()}));const P=async()=>{if(O.interrupted)return;let e=await J.upload.taskState(K.value.taskId);if(e){if(O=Object.assign(O,e.data),O.interrupted)return void(O.progress=100);if(O.finish)return;setTimeout((()=>{P()}),1e3)}},U=(e,t)=>{let s=Math.floor(t/1e3)%60;return s>0?(e/s).toFixed(2):0},X=()=>{let{total:e,completed:t,elapsedTime:s,interrupted:r}=O,a=(e-t)*U(t,s)*1e3;return r?"00:00:00":Y(a)},Y=e=>{if(e<1e3)return"00:00:00";return Q(Math.floor(e/36e5)%24)+":"+Q(Math.floor(e/6e4)%60)+":"+Q(Math.floor(e/1e3)%60)},Q=e=>e<10?"0"+e:e,W=async()=>{x.confirm("确认中止导入？请注意已导入的数据无法自动删除","提示：",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((async()=>{if(O.finish)return void H.error("无法中止，因为任务已经完成");await J.upload.taskCancel(K.value.taskId)&&(O.interrupted=!0,O.progress=100)})).catch((()=>{}))};let Z=t(!1),ee=t(!1),te=t([]);const se=()=>{Z.value=!0,re()},re=async()=>{ee.value=!0;let e=await J.upload.importTrace(K.value.taskId);e&&(te.value=e.data),ee.value=!1};let ae=t("");const oe=e=>{ae.value.openDialog(e.recordId)},ie=()=>{L("reset")};return(e,t)=>{const s=a("el-button"),r=a("el-table-column"),k=a("ElIconEdit"),x=a("el-icon"),L=a("el-table"),$=a("ml-dialog"),H=o("loading");return i(),l(w,null,[p("div",_,[p("div",C,[p("div",T,[p("div",D,[n(O).finish||n(O).interrupted?d("",!0):(i(),l("span",I,"正在导入..."+m(n(O).completed)+"/"+m(n(O).total),1)),n(O).finish&&!n(O).interrupted?(i(),l("span",z,"导入完成。共成功导入 "+m(n(O).succeeded)+" 条记录",1)):d("",!0),n(O).interrupted?(i(),l("span",M,"导入被中止。已成功导入 "+m(n(O).completed)+" 条记录",1)):d("",!0)]),p("div",E,"耗时 "+m(Y(n(O).elapsedTime))+" · 速度"+m(U(n(O).completed,n(O).elapsedTime))+"条/秒 · 剩余时间 "+m(X(n(O))),1)]),p("div",R,[p("div",{class:"import-progress-bar",style:u({width:100*n(O).progress+"%"})},null,4)]),p("div",V,[n(O).finish?(i(),c(s,{key:0,type:"danger",style:{width:"80px"},disabled:""},{default:j((()=>[f("导入完成")])),_:1})):d("",!0),n(O).finish?d("",!0):(i(),c(s,{key:1,type:"danger",style:{width:"80px"},onClick:W},{default:j((()=>[f("终止导入")])),_:1})),v(s,{style:{width:"80px"},onClick:se},{default:j((()=>[f("导入详情")])),_:1}),p("span",{class:"ml-a-span ml-20",onClick:ie},"继续导入")]),v($,{title:"导入详情",width:"500",modelValue:n(Z),"onUpdate:modelValue":t[0]||(t[0]=e=>g(Z)?Z.value=e:Z=e)},{default:j((()=>[h((i(),c(L,{data:n(te),style:{width:"100%"},"highlight-current-row":"","max-height":"400px"},{default:j((()=>[v(r,{label:"行号",width:"50"},{default:j((e=>[f(m(e.row.rowNo),1)])),_:1}),v(r,{label:"状态",width:"100"},{default:j((e=>[4==e.row.type?(i(),l("span",F," 失败 ")):d("",!0),1==e.row.type?(i(),l("span",A," 跳过 ")):d("",!0),2==e.row.type?(i(),l("span",{key:2,class:"ml-a-span",onClick:y((t=>oe(e.row)),["stop"])},[f(" 新建成功 "),p("span",q,[v(x,null,{default:j((()=>[v(k)])),_:1})])],8,N)):d("",!0),3==e.row.type?(i(),l("span",{key:3,class:"ml-a-span",onClick:y((t=>oe(e.row)),["stop"])},[f(" 更新成功 "),p("span",S,[v(x,null,{default:j((()=>[v(k)])),_:1})])],8,B)):d("",!0)])),_:1}),v(r,{label:"详情","show-overflow-tooltip":""},{default:j((e=>[p("div",G,m(e.row.message||"-"),1)])),_:1})])),_:1},8,["data"])),[[H,n(ee)]])])),_:1},8,["modelValue"])])]),v(b,{ref_key:"detailRefs",ref:ae},null,512)],64)}}},[["__scopeId","data-v-62f4b25f"]]);export{L as default};
