import{_ as e,ad as t,ae as l,a9 as i,ak as a,a0 as s,ao as r,ap as o}from"./index-ea085229.js";import{F as d}from"./field-state-variables-3bb6d4cb.js";import{l as n,o as f,i as m,w as p,z as u,f as h,c,a0 as g,ah as y,a as b,A as E,F,g as j,t as _,bh as w,bf as v}from"./@vue-1ad4818c.js";import"./element-plus-bab58d46.js";import"./lodash-es-b8e8104a.js";import"./@vueuse-477b4dbb.js";import"./@element-plus-2a6d398c.js";import"./@babel-6bd44fd1.js";import"./@popperjs-b78c3215.js";import"./@ctrl-4982d949.js";import"./dayjs-7fb79ad3.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./escape-html-3148dbc9.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-0ef99041.js";import"./vue3-manner-report-313033e6.js";import"./axios-85bcd05e.js";import"./crypto-js-43a3a23e.js";import"./cron-parser-1391a961.js";import"./luxon-b01799b6.js";import"./vue-router-414ebc36.js";import"./nprogress-c04e6182.js";import"./pinia-3f60a8e1.js";import"./sortablejs-2f5483e3.js";import"./qrcodejs2-fix-bab07f30.js";import"./moment-bafe441d.js";import"./pinyin-pro-c81f5d39.js";import"./vue-i18n-0843b5c5.js";import"./@intlify-2528d766.js";import"./source-map-b06bd4b9.js";import"./vue-c723f8b1.js";import"./pinia-plugin-persistedstate-d2bd58cf.js";import"./resize-observer-polyfill-ad543aa3.js";import"./vue-smart-widget-8b3f5b0a.js";import"./echarts-b5d24e9a.js";import"./zrender-a15b073b.js";import"./tslib-a4e99503.js";import"./echarts-liquidfill-f5c863f1.js";import"./@antv-43d380be.js";import"./ant-design-vue-2db0c9af.js";import"./@ant-design-60f2ef8e.js";import"./vue-types-6bcea8eb.js";import"./dom-align-78cb5391.js";import"./vue-draggable-next-a413f884.js";import"./vue-resize-observer-90aea344.js";const P={name:"ReferenceListWidgetEditor",props:{entity:String,fieldName:String,showingInDialog:Boolean,fieldState:{type:Number,default:d.NEW}},data(){return{fieldProps:{name:"",label:"",type:"ReferenceList",defaultMemberOfListFlag:!1,nullable:!1,creatable:!0,updatable:!0,fieldViewModel:{searchDialogWidth:520,validators:[]},referTo:[],referenceSetting:[]},rules:{name:[{required:!0,message:"请输入字段名称",trigger:"blur"},{pattern:/^[a-z]+[A-Za-z\d]*$/,message:"请以小写英文字母开头，中间可输入字母或数字，禁止中文",trigger:"blur"},{min:2,max:30,message:"文字长度应在2-30之间",trigger:"blur"}],label:[{required:!0,message:"请输入显示名称",trigger:"blur"},{pattern:/^[A-Za-z\d\u4e00-\u9fa5]+[_-]*/,message:"请以中文、英文字母、数字开头，中间可输入下划线或横杠",trigger:"blur"},{min:2,max:30,message:"文字长度应在2-30之间",trigger:"blur"}]},validators:[],refEntityIndex:-1,referenceList:[{currentRefEntity:"",selectedFieldItems:[],refEntityAndFields:""}],refEntityName:"",refEntityLabel:"",refEntityFullName:"",showRefEntityDialogFlag:!1,showEntityListDialogFlag:!1,fieldItems:[],selectedFieldItems:[],columns:[{prop:"name",label:"实体名称",width:"150",align:"center"},{prop:"label",label:"显示名称",width:"200",align:"center",formatter:this.formatter}],tableData:[]}},mounted(){this.fieldState===d.EDIT&&this.getFieldProps()},methods:{async getFieldProps(){let e=await t(this.fieldName,this.entity);e&&200==e.code&&e.data&&this.readFieldProps(e.data)},readFieldProps(e){l(this.fieldProps,e),this.fieldProps.fieldViewModel||(this.fieldProps.fieldViewModel={searchDialogWidth:520}),e.entityCode&&(this.fieldProps.entityCode=e.entityCode)},saveField(){this.$refs.editorForm.validate((async e=>{if(!e)return this.$message.error("数据不合规范，请检查"),!1;if(this.fieldProps.referTo.length<=0||!this.fieldProps.referenceSetting)return void this.$message.error("请设置引用实体！");this.fieldProps.type="ReferenceList";let t="";this.fieldProps.referTo.forEach(((e,l)=>{l!==this.fieldProps.referTo.length-1?t+=e+",":t+=e}));let l=r;this.fieldState===d.EDIT&&(l=o);let i=await l(this.fieldProps,this.entity,t);i&&200==i.code&&(this.$message.success("保存成功"),this.$emit("fieldSaved"))}))},cancelSave(){this.$emit("cancelSave")},clearReferTo(e){this.referenceList[e].currentRefEntity="",this.referenceList[e].refEntityAndFields="",this.buildReferToAndReferenceSetting()},showRefEntitySettingDialog(e){this.showRefEntityDialogFlag=!0,this.refEntityIndex=e,this.refEntityName="",this.refEntityLabel="",this.refEntityFullName="",this.fieldItems.length=0,this.selectedFieldItems.length=0},setRefEntity(){if(this.selectedFieldItems.length<=0)return void this.$message.info("请至少选择一个显示字段！");let e=this.refEntityLabel+"[";for(let t=0;t<this.selectedFieldItems.length;t++)e+=this.selectedFieldItems[t].label+",";e+="]",this.referenceList[this.refEntityIndex].refEntityAndFields=e,this.referenceList[this.refEntityIndex].currentRefEntity=this.refEntityName,this.referenceList[this.refEntityIndex].selectedFieldItems=JSON.parse(JSON.stringify(this.selectedFieldItems)),this.buildReferToAndReferenceSetting(),this.showRefEntityDialogFlag=!1},async showEntityListDialog(){this.tableData.length=0;let e=await i();if(e&&200==e.code){let t=e.data;t&&t.filter((e=>{!1===e.detailEntityFlag&&this.tableData.push({name:e.name,label:e.label})})),this.showEntityListDialogFlag=!0}},async selectEntity(e){this.refEntityName=e.name,this.refEntityLabel=e.label,this.refEntityFullName=this.refEntityLabel+"("+this.refEntityName+")",this.showEntityListDialogFlag=!1,this.fieldItems.length=0;let t=await a(this.refEntityName);if(t&&200==t.code){let e=t.data;e&&e.filter((e=>{"PrimaryKey"!==e.type&&this.fieldItems.push(e)}))}},setRefEntityListField(e,t){if(t)this.selectedFieldItems.push(e);else for(let l=this.selectedFieldItems.length-1;l>=0;l--)this.selectedFieldItems[l].name===e.name&&this.selectedFieldItems.splice(l,1)},addRefEntity(){this.referenceList.push({currentRefEntity:"",selectedFieldItems:[],refEntityAndFields:""})},deleteRefEntity(e){this.referenceList.splice(e,1),this.buildReferToAndReferenceSetting()},buildReferToAndReferenceSetting(){this.fieldProps.referTo.length=0,this.fieldProps.referenceSetting.length=0,this.referenceList.forEach((e=>{if(e.currentRefEntity&&e.selectedFieldItems){let t=[];e.selectedFieldItems.forEach((e=>{t.push(e.name)})),this.fieldProps.referTo.push(e.currentRefEntity),this.fieldProps.referenceSetting.push({entityName:e.currentRefEntity,fieldList:t})}}))},handleFieldLabelChange(e){e&&(this.fieldProps.name||(this.fieldProps.name=s(e)))},generateFieldName(){this.fieldProps.name=s(this.fieldProps.label)}}},V=e=>(w("data-v-aea859d8"),e=e(),v(),e),R=V((()=>j("hr",{style:{border:"0","margin-bottom":"15px"}},null,-1))),k=V((()=>j("hr",{style:{border:"0","border-top":"1px dotted #cccccc",margin:"-8px 0 12px"}},null,-1))),I=V((()=>j("hr",{style:{border:"0","margin-bottom":"15px"}},null,-1))),L=V((()=>j("div",{style:{"margin-bottom":"6px"}},"选择实体搜索列表字段：",-1))),C={key:0,style:{"font-style":"italic"}},D=V((()=>j("div",{style:{margin:"20px 0 6px"}},"已选择的显示字段：",-1))),x={key:0,style:{"font-style":"italic"}},S={class:"dialog-footer"};const N=e(P,[["render",function(e,t,l,i,a,s){const r=n("el-header"),o=n("el-input"),d=n("el-form-item"),w=n("el-button"),v=n("el-input-number"),P=n("el-radio"),V=n("el-radio-group"),N=n("el-form"),T=n("el-main"),A=n("el-checkbox"),U=n("el-card"),z=n("el-container"),M=n("el-dialog"),$=n("SimpleTable");return f(),m(z,{class:"field-props-container"},{default:p((()=>[l.showingInDialog?h("",!0):(f(),m(r,{key:0,class:"field-props-header"},{default:p((()=>[u("[多对多引用]字段属性设置")])),_:1})),c(T,{class:"field-props-pane"},{default:p((()=>[c(N,{ref:"editorForm",model:a.fieldProps,rules:a.rules,"label-position":"left","label-width":"220px",onSubmit:t[7]||(t[7]=g((()=>{}),["prevent"]))},{default:p((()=>[c(d,{label:"显示名称",prop:"label"},{default:p((()=>[c(o,{modelValue:a.fieldProps.label,"onUpdate:modelValue":t[0]||(t[0]=e=>a.fieldProps.label=e),onChange:s.handleFieldLabelChange},null,8,["modelValue","onChange"])])),_:1}),c(d,{label:"字段名称",prop:"name"},{default:p((()=>[c(o,{modelValue:a.fieldProps.name,"onUpdate:modelValue":t[1]||(t[1]=e=>a.fieldProps.name=e),disabled:1!==l.fieldState},y({_:2},[1===l.fieldState?{name:"append",fn:p((()=>[c(w,{onClick:s.generateFieldName},{default:p((()=>[u("刷新生成")])),_:1},8,["onClick"])])),key:"0"}:void 0]),1032,["modelValue","disabled"])])),_:1}),c(d,{label:"引用实体设置"},{default:p((()=>[c(w,{style:{float:"right"},icon:"el-icon-plus",onClick:s.addRefEntity},{default:p((()=>[u("添加")])),_:1},8,["onClick"])])),_:1}),R,(f(!0),b(F,null,E(a.referenceList,((e,t)=>(f(),m(d,{label:"引用实体"+(t+1),key:t},{default:p((()=>[c(o,{modelValue:e.refEntityAndFields,"onUpdate:modelValue":t=>e.refEntityAndFields=t,readonly:""},{append:p((()=>[e.currentRefEntity?(f(),m(w,{key:0,icon:"el-icon-close",title:"清除",onClick:e=>s.clearReferTo(t)},null,8,["onClick"])):h("",!0),c(w,{icon:"el-icon-search",title:"选择",onClick:e=>s.showRefEntitySettingDialog(t)},null,8,["onClick"]),c(w,{icon:"el-icon-delete",title:"删除",onClick:e=>s.deleteRefEntity(t)},null,8,["onClick"])])),_:2},1032,["modelValue","onUpdate:modelValue"])])),_:2},1032,["label"])))),128)),k,c(d,{label:"搜索弹窗宽度（单位：像素）："},{default:p((()=>[c(v,{type:"number",modelValue:a.fieldProps.fieldViewModel.searchDialogWidth,"onUpdate:modelValue":t[2]||(t[2]=e=>a.fieldProps.fieldViewModel.searchDialogWidth=e),modelModifiers:{number:!0},style:{width:"100%"}},null,8,["modelValue"])])),_:1}),c(d,{label:"是否在列表中默认显示"},{default:p((()=>[c(V,{modelValue:a.fieldProps.defaultMemberOfListFlag,"onUpdate:modelValue":t[3]||(t[3]=e=>a.fieldProps.defaultMemberOfListFlag=e),style:{float:"right"}},{default:p((()=>[c(P,{label:!0},{default:p((()=>[u("是")])),_:1}),c(P,{label:!1},{default:p((()=>[u("否")])),_:1})])),_:1},8,["modelValue"])])),_:1}),c(d,{label:"是否允许空值"},{default:p((()=>[c(V,{modelValue:a.fieldProps.nullable,"onUpdate:modelValue":t[4]||(t[4]=e=>a.fieldProps.nullable=e),style:{float:"right"}},{default:p((()=>[c(P,{label:!0},{default:p((()=>[u("是")])),_:1}),c(P,{label:!1},{default:p((()=>[u("否")])),_:1})])),_:1},8,["modelValue"])])),_:1}),c(d,{label:"新建记录时允许修改字段"},{default:p((()=>[c(V,{modelValue:a.fieldProps.creatable,"onUpdate:modelValue":t[5]||(t[5]=e=>a.fieldProps.creatable=e),style:{float:"right"}},{default:p((()=>[c(P,{label:!0},{default:p((()=>[u("是")])),_:1}),c(P,{label:!1},{default:p((()=>[u("否")])),_:1})])),_:1},8,["modelValue"])])),_:1}),c(d,{label:"更新记录时允许修改字段"},{default:p((()=>[c(V,{modelValue:a.fieldProps.updatable,"onUpdate:modelValue":t[6]||(t[6]=e=>a.fieldProps.updatable=e),style:{float:"right"}},{default:p((()=>[c(P,{label:!0},{default:p((()=>[u("是")])),_:1}),c(P,{label:!1},{default:p((()=>[u("否")])),_:1})])),_:1},8,["modelValue"])])),_:1}),I,c(d,null,{default:p((()=>[c(w,{type:"primary",style:{width:"120px"},onClick:s.saveField},{default:p((()=>[u("保存字段")])),_:1},8,["onClick"]),l.showingInDialog?(f(),m(w,{key:0,onClick:s.cancelSave},{default:p((()=>[u("取消")])),_:1},8,["onClick"])):h("",!0)])),_:1})])),_:1},8,["model","rules"])])),_:1}),c(M,{title:"引用实体设置",class:"refer-entity-dialog",modelValue:a.showRefEntityDialogFlag,"onUpdate:modelValue":t[10]||(t[10]=e=>a.showRefEntityDialogFlag=e),"append-to-body":!0,width:"560px"},{footer:p((()=>[j("div",S,[c(w,{onClick:t[9]||(t[9]=e=>a.showRefEntityDialogFlag=!1)},{default:p((()=>[u("取 消")])),_:1}),c(w,{type:"primary",onClick:s.setRefEntity},{default:p((()=>[u("确 定")])),_:1},8,["onClick"])])])),default:p((()=>[c(z,null,{default:p((()=>[c(r,null,{default:p((()=>[c(o,{placeholder:"请选择引用实体",modelValue:a.refEntityFullName,"onUpdate:modelValue":t[8]||(t[8]=e=>a.refEntityFullName=e)},{append:p((()=>[c(w,{icon:"el-icon-search",title:"选择",onClick:s.showEntityListDialog},null,8,["onClick"])])),_:1},8,["modelValue"])])),_:1}),c(T,null,{default:p((()=>[j("div",null,[L,c(U,{shadow:"never"},{default:p((()=>[a.fieldItems.length<=0?(f(),b("div",C,"暂无字段可选")):h("",!0),(f(!0),b(F,null,E(a.fieldItems,((e,t)=>(f(),m(A,{key:t,onChange:t=>s.setRefEntityListField(e,t)},{default:p((()=>[u(_(e.label)+"("+_(e.name)+")",1)])),_:2},1032,["onChange"])))),128))])),_:1})]),j("div",null,[D,c(U,{shadow:"never"},{default:p((()=>[a.selectedFieldItems.length<=0?(f(),b("div",x,"未选择显示字段")):h("",!0),(f(!0),b(F,null,E(a.selectedFieldItems,((e,t)=>(f(),b("div",{key:t},_(e.label)+"("+_(e.name)+")",1)))),128))])),_:1})])])),_:1})])),_:1})])),_:1},8,["modelValue"]),c(M,{ref:"entityListDlg",title:"选择引用实体",modelValue:a.showEntityListDialogFlag,"onUpdate:modelValue":t[11]||(t[11]=e=>a.showEntityListDialogFlag=e),"append-to-body":!0,class:"entity-list-dialog",width:"560px"},{default:p((()=>[c($,{"show-pagination":!1,"show-check-box":!1,"table-size":"small",columns:a.columns,data:a.tableData,"show-operation-column":!0,"max-height":420},{table_operation:p((({scope:e})=>[c(w,{class:"",icon:"el-icon-check",onClick:t=>s.selectEntity(e.row)},{default:p((()=>[u("选择")])),_:2},1032,["onClick"])])),_:1},8,["columns","data"])])),_:1},8,["modelValue"])])),_:1})}],["__scopeId","data-v-aea859d8"]]);export{N as default};
