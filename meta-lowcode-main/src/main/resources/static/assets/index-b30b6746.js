import{R as e,r as l,u as a,p as t,v as o,l as s,o as u,a as n,E as d,i,w as c,c as r,G as v,X as m,z as p,f,g as k,a0 as w,F as _,A as g,t as h,e as y,bh as b,bf as x}from"./@vue-1ad4818c.js";import{_ as V}from"./index-ea085229.js";import{C}from"./element-plus-bab58d46.js";const $=e=>(b("data-v-6d691123"),e=e(),x(),e),E={key:0,class:"input-box"},R={key:1,class:"foot-box mt-10"},A=$((()=>k("span",{class:"help"},"如何使用高级计算公式?",-1))),D={key:2,class:"input-box"},F={key:0,class:"formula-val mb-10 need-change"},N={class:"el-dropdown-link"},S={key:1,class:"formula-val mb-10 need-change default-icon"},T=$((()=>k("span",{class:"not-val"},"计算公式",-1))),I={class:"active-box"},L={class:"active-l fl"},j=["onClick","title"],z=$((()=>k("span",{class:"active-type"},"N",-1))),U={class:"active-r fl"},B=["onClick"],G=["onClick","title"],H={class:"save-success"},M={class:"mt-5 error-content"},P=$((()=>k("div",{class:"mt-5 save-info"},"计算公式可能存在错误，这会导致触发器执行失败。是否继续？",-1))),W={class:"mt-20"},X=V({__name:"index",props:{modelValue:null,fields:{type:Array,default:()=>[]},defaultFormulaVal:{type:String,default:""},isAdvanced:{type:Boolean,default:!1}},emits:["update:modelValue","confirm"],setup(b,{emit:x}){const V=b,$=e("$API");e("$ElMessage");const X=l(),q=l();let J=l(!1),K=l(""),O=l([]),Q=l([{row:1,value:["+","1","2","3"]},{row:2,value:["-","4","5","6"]},{row:3,value:["*","7","8","9"]},{row:4,value:["/","(",")","0"]},{row:5,value:[".","回退","清空","确定"]}]),Y=l();a((()=>J.value),(e=>{x("update:modelValue",e)}),{deep:!0}),t((()=>{J.value=V.modelValue,K.value=V.defaultFormulaVal,Y.value=V.isAdvanced}));const Z=()=>{var e,l;null==(l=null==(e=d(q).popperRef)?void 0:e.delayHide)||l.call(e)};let ee=o({sum:"求和",count:"计数",countSet:"去重计数",average:"平均值",max:"最大值",min:"最小值"}),le=l(""),ae=l(0);const te=e=>{ae.value=e.srcElement.selectionStart},oe=(e,l)=>{if(l){let l={value:"field",label:`{${e.fieldLabel}`,dropdownText:"(求和)}",checkField:e.fieldName,checkDropdown:"sum"};O.value.push(l)}else{K.value=(a=K.value||"",t=ae.value,o=`{${e.fieldName}}`,a.slice(0,t)+o+a.slice(t));let l=ae.value+e.fieldName.length+2;le.value.focus(),setTimeout((()=>{le.value.ref.setSelectionRange(l,l)}),10),q.value.hide()}var a,t,o};let se=l(!1),ue=l(""),ne=l("");const de=async()=>{let e="";if(Y.value?e=K.value:(O.value.forEach((l=>{l.checkField?e+="{"+l.checkField+(l.checkDropdown?`$${l.checkDropdown}`:"")+"}":e+=l.label})),O.value=[]),ne.value=e,e){let l=await $.trigger.detial.aviatorValidate(e);l&&(l.data?(se.value=!0,ue.value=l.data):ie())}},ie=()=>{J.value=!1,se.value=!1,x("confirm",{label:K.value,value:ne.value}),x("update:modelValue",J.value)};return(e,l)=>{const a=s("el-input"),t=s("el-button"),o=s("ElIconConnection"),x=s("el-icon"),V=s("el-icon-arrow-down"),$=s("el-dropdown-item"),ae=s("el-dropdown-menu"),ne=s("el-dropdown"),ce=s("el-col"),re=s("el-row"),ve=s("el-popover"),me=s("mlDialog"),pe=s("ElIconWarning"),fe=s("ml-dialog");return u(),n(_,null,[d(se)?f("",!0):(u(),i(me,{key:0,modelValue:d(J),"onUpdate:modelValue":l[3]||(l[3]=e=>v(J)?J.value=e:J=e),width:"550",title:"计算公式"},{default:c((()=>[d(Y)?(u(),n("div",E,[r(a,{modelValue:d(K),"onUpdate:modelValue":l[0]||(l[0]=e=>v(K)?K.value=e:K=e),placeholder:"// 支持 AviatorScript",autosize:{minRows:8},type:"textarea",onBlur:te,ref_key:"contentInputRef",ref:le},null,8,["modelValue"]),m((u(),n("span",{ref_key:"buttonRef",ref:X,class:"field-span"},[p("{ }")])),[[d(C),Z]])])):f("",!0),d(Y)?(u(),n("div",R,[A,r(t,{type:"primary",class:"fr",onClick:de},{default:c((()=>[p("确定")])),_:1})])):f("",!0),d(Y)?f("",!0):(u(),n("div",D,[d(O).length>0?(u(),n("div",F,[k("span",{class:"change-span",onClick:l[1]||(l[1]=w((e=>v(Y)?Y.value=!d(Y):Y=!d(Y)),["stop"]))},[r(x,null,{default:c((()=>[r(o)])),_:1})]),(u(!0),n(_,null,g(d(O),((e,l)=>(u(),n(_,{key:l},["field"==e.value?(u(),i(ne,{key:0,trigger:"click",onCommand:l=>((e,l)=>{"无"===e?(l.dropdownText="}",l.checkDropdown=""):(l.dropdownText=`(${ee[e]})`,l.checkDropdown=`(${e})`)})(l,e)},{dropdown:c((()=>[r(ae,null,{default:c((()=>[r($,{command:"无"},{default:c((()=>[p("无")])),_:1}),r($,{command:"sum"},{default:c((()=>[p("求和")])),_:1}),r($,{command:"count"},{default:c((()=>[p("计数")])),_:1}),r($,{command:"countSet"},{default:c((()=>[p("去重计数")])),_:1}),r($,{command:"average"},{default:c((()=>[p("平均值")])),_:1}),r($,{command:"max"},{default:c((()=>[p("最大值")])),_:1}),r($,{command:"min"},{default:c((()=>[p("最小值")])),_:1})])),_:1})])),default:c((()=>[k("span",N,[p(h(e.label)+h(e.dropdownText)+" ",1),r(x,{class:"el-icon--right"},{default:c((()=>[r(V)])),_:1})])])),_:2},1032,["onCommand"])):(u(),n("i",{key:1,class:y(["v",{oper:"oper"==e.value,num:"num"==e.value}])},h(e.label),3))],64)))),128))])):(u(),n("div",S,[T,k("span",{class:"change-span",onClick:l[2]||(l[2]=w((e=>v(Y)?Y.value=!d(Y):Y=!d(Y)),["stop"]))},[r(x,null,{default:c((()=>[r(o)])),_:1})])])),k("div",I,[k("div",L,[(u(!0),n(_,null,g(b.fields,((l,a)=>(u(),n("div",{class:"active-item text-ellipsis",key:a,onClick:e=>oe(l,!0),title:e.tem.fieldLabel},[z,p(" "+h(l.fieldLabel),1)],8,j)))),128))]),k("div",U,[(u(!0),n(_,null,g(d(Q),((e,l)=>(u(),i(re,{gutter:5,class:"mb-5",key:l},{default:c((()=>[(u(!0),n(_,null,g(e.value,((e,l)=>(u(),i(ce,{span:6,key:l},{default:c((()=>[k("span",{class:y(["subitem-span",{isConfirm:"确定"==e}]),onClick:l=>(e=>{if("确定"==e)K.value="",O.value.forEach((e=>{K.value+=e.label+(e.dropdownText||"")})),de();else if("清空"==e)O.value=[];else if("回退"==e)O.value.splice(O.value.length-1,1);else{let l={label:e};isNaN(e)?l.value="oper":l.value="num",O.value.push(l)}})(e)},h(e),11,B)])),_:2},1024)))),128))])),_:2},1024)))),128))])])])),r(ve,{ref_key:"popoverRef",ref:q,"virtual-ref":X.value,trigger:"click",placement:"left","popper-class":"formula-popover","virtual-triggering":""},{default:c((()=>[(u(!0),n(_,null,g(b.fields,((e,l)=>(u(),n("div",{class:"field-item text-ellipsis",key:l,onClick:l=>oe(e),title:e.fieldLabel},h(e.fieldLabel),9,G)))),128))])),_:1},8,["virtual-ref"])])),_:1},8,["modelValue"])),d(se)?(u(),i(fe,{key:1,modelValue:d(se),"onUpdate:modelValue":l[5]||(l[5]=e=>v(se)?se.value=e:se=e),width:"500","not-header":"",top:"30vh"},{default:c((()=>[k("div",H,[k("div",null,[r(x,{class:"save-icon",size:"50"},{default:c((()=>[r(pe)])),_:1})]),k("div",M,h(d(ue)),1),P,k("div",W,[r(t,{onClick:l[4]||(l[4]=e=>{v(se)?se.value=!1:se=!1})},{default:c((()=>[p("取消")])),_:1}),r(t,{type:"warning",onClick:ie},{default:c((()=>[p("确定")])),_:1})])])])),_:1},8,["modelValue"])):f("",!0)],64)}}},[["__scopeId","data-v-6d691123"]]);export{X as m};
