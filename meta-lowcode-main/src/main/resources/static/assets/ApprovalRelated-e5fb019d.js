import{u as e}from"./vue-router-414ebc36.js";import{_ as a,f as l,j as t,h as o,q as n,s as i}from"./index-ea085229.js";import{S as s,T as d}from"./@element-plus-2a6d398c.js";import{s as u}from"./pinia-3f60a8e1.js";import{R as r,r as p,u as c,p as m,v,l as f,Y as y,o as k,a as g,c as _,w,g as b,z as I,t as V,G as h,X as C,E as S,i as x,f as U,F as R,n as N,A as L,ac as A,bh as T,bf as F}from"./@vue-1ad4818c.js";import{b as j,a as B}from"./element-plus-bab58d46.js";const E={class:"detail-header"},O={class:"fr fr-box"},D={class:"detail-main"},z={class:"foot-btn w-100"},q={class:"el-dropdown-link"},J={class:"foot-btn w-100"},M=a({__name:"index",props:{modelValue:null,taskId:{type:String,default:""},entityId:{type:String,default:""},title:{type:String,default:""},approvalName:{type:String,default:""}},emits:["update:modelValue","canner","confirm"],setup(e,{emit:a}){const L=e,{allEntityName:A}=u(l()),T=r("$ElMessage");let F=p(!1),j=p(null),B=p({remark:"",nextApprovalUserList:[],currentCCToUserList:[],entityId:"",isBacked:!1}),M=p({}),P=p(!1),W=p(!1),$=p({title:"转审",type:1,entityId:"",nodeRoleList:[]});c((()=>L.modelValue),(()=>{j.value=L.modelValue}),{deep:!0}),c((()=>j.value),(e=>{a("update:modelValue",e)}),{deep:!0}),m((()=>{j.value=L.modelValue,async function(){F.value=!0;let e=await t.get("/approval/getApprovalTaskById",{approvalTaskId:L.taskId});e?(M.value=e.data,(async()=>{var e;F.value=!0;let a=await o(A.value[M.value.entityCode]);a&&(null==(e=a.data)?void 0:e.layoutJson)?(H.value=!0,Q.value=a.data.optionData||{},N((async()=>{let e=await n(L.entityId);G.value.setFormJson(a.data.layoutJson),e&&(G.value.setFormData(e.data),N((()=>{"{}"==JSON.stringify(Q.value)&&G.value.reloadOptionData(),G.value.disableForm();let e=M.value.modifiableFields.map((e=>e.name));G.value.enableWidgets(e),G.value.showWidgets(e);let a=M.value.modifiableFields.map((e=>e.isRequired?e.name:null));G.value.setWidgetsRequired(a,!0)}))),F.value=!1}))):F.value=!1})()):F.value=!1}()}));const G=p();let H=p(!1),Q=p({}),X=v({}),Y=v({});function K(e){P.value=!0,$.value.title=1==e?"转审":"加签",$.value.type=e,$.value.entityId=L.entityId,$.value.nodeRoleList=[]}async function Z(){let{type:e,title:l}=$.value;$.value.nodeRoleList.length<1?T.warning("请选择要"+l+"到哪些人员"):(W.value=!0,await t.post("/approval/taskOperation",$.value)&&(T.success(l+"成功"),P.value=!1,1==e&&(ae(),a("confirm"))),W.value=!1)}async function ee(e){let l=await G.value.getFormData();if(l){if(F.value=!0,await i(A.value[M.value.entityCode],L.entityId,l)){if(B.value.entityId=L.entityId,B.value.isBacked=e,await t.post("/approval/approvalProcess",B.value)){let l=e?"驳回":"审批";T.success(l+"成功"),ae(),a("confirm")}F.value=!1}else F.value=!1}}function ae(){j.value=!1}return(a,l)=>{const t=f("ElIconCloseBold"),o=f("el-icon"),n=f("v-form-render"),i=f("el-empty"),u=f("el-col"),r=f("el-input"),p=f("el-form-item"),c=f("el-icon-user-filled"),m=f("mlSelectUser"),v=f("el-icon-promotion"),N=f("ElIconMoreFilled"),L=f("el-dropdown-item"),A=f("el-dropdown-menu"),T=f("el-dropdown"),le=f("el-button"),te=f("el-form"),oe=f("el-row"),ne=f("el-drawer"),ie=f("mlDialog"),se=y("loading");return k(),g(R,null,[_(ne,{size:"73%",class:"ml-drawer",modelValue:S(j),"onUpdate:modelValue":l[6]||(l[6]=e=>h(j)?j.value=e:j=e),direction:"rtl","show-close":!1},{header:w((()=>[b("div",E,[I(V(e.approvalName)+" 审批 ",1),b("div",O,[b("span",{class:"fr-icon",onClick:l[0]||(l[0]=e=>h(j)?j.value=!1:j=!1)},[_(o,null,{default:w((()=>[_(t)])),_:1})])])])])),default:w((()=>[C((k(),g("div",D,[_(oe,{gutter:20},{default:w((()=>[_(u,{span:S(M).type?18:24},{default:w((()=>[S(H)?(k(),x(n,{key:0,ref_key:"vFormRef",ref:G,"option-data":S(Q),"form-data":S(X),"global-dsv":S(Y)},null,8,["option-data","form-data","global-dsv"])):(k(),x(i,{key:1,"image-size":100,description:S(M).type?"未查询到相关配置数据":"该流程已结束或者流程异常"},null,8,["description"]))])),_:1},8,["span"]),S(M).type?(k(),x(u,{key:0,span:6},{default:w((()=>[_(te,{"label-position":"top","label-width":"100px"},{default:w((()=>[_(p,{label:"批注"},{default:w((()=>[_(r,{modelValue:S(B).remark,"onUpdate:modelValue":l[1]||(l[1]=e=>S(B).remark=e),autosize:{minRows:4,maxRows:6},type:"textarea",placeholder:"输入批注(可选)",maxlength:"500","show-word-limit":""},null,8,["modelValue"])])),_:1}),S(M).userSelectFlag?(k(),x(p,{key:0},{label:w((()=>[_(o,{class:"icon filled-icon"},{default:w((()=>[_(c)])),_:1}),I("下一审批人(或签) ")])),default:w((()=>[_(m,{modelValue:S(B).nextApprovalUserList,"onUpdate:modelValue":l[2]||(l[2]=e=>S(B).nextApprovalUserList=e),multiple:"",clearable:""},null,8,["modelValue"])])),_:1})):U("",!0),_(p,null,{label:w((()=>[_(o,{class:"icon promotion-icon"},{default:w((()=>[_(v)])),_:1}),I("本次审批结果将抄送给 ")])),default:w((()=>[_(m,{modelValue:S(B).currentCCToUserList,"onUpdate:modelValue":l[3]||(l[3]=e=>S(B).currentCCToUserList=e),multiple:"",clearable:""},null,8,["modelValue"])])),_:1}),_(p,{style:{"margin-bottom":"0"}},{default:w((()=>[b("div",z,[S(M).transferApproval||S(M).addSignaturesApproval?(k(),x(T,{key:0,trigger:"click",onCommand:K},{dropdown:w((()=>[_(A,null,{default:w((()=>[S(M).transferApproval?(k(),x(L,{key:0,icon:S(s),command:1},{default:w((()=>[I("转审")])),_:1},8,["icon"])):U("",!0),S(M).addSignaturesApproval?(k(),x(L,{key:1,icon:S(d),command:2},{default:w((()=>[I("加签")])),_:1},8,["icon"])):U("",!0)])),_:1})])),default:w((()=>[b("span",q,[_(o,{class:"el-icon--right"},{default:w((()=>[_(N)])),_:1})])])),_:1})):U("",!0),_(le,{type:"primary",onClick:l[4]||(l[4]=e=>ee(!1))},{default:w((()=>[I("同意")])),_:1}),_(le,{type:"danger",onClick:l[5]||(l[5]=e=>ee(!0))},{default:w((()=>[I("驳回")])),_:1}),_(le,{onClick:ae},{default:w((()=>[I("取消")])),_:1})])])),_:1})])),_:1})])),_:1})):U("",!0)])),_:1})])),[[se,S(F)]])])),_:1},8,["modelValue"]),_(ie,{modelValue:S(P),"onUpdate:modelValue":l[9]||(l[9]=e=>h(P)?P.value=e:P=e),title:S($).title,width:"35%",appendToBody:""},{default:w((()=>[C((k(),x(te,{"label-position":"top","label-width":"100px"},{default:w((()=>[_(p,{label:S($).title+"到哪些用户"},{default:w((()=>[_(m,{type:"User",modelValue:S($).nodeRoleList,"onUpdate:modelValue":l[7]||(l[7]=e=>S($).nodeRoleList=e),multiple:"",clearable:""},null,8,["modelValue"])])),_:1},8,["label"]),_(p,{style:{"margin-bottom":"0"}},{default:w((()=>[b("div",J,[_(le,{type:"primary",onClick:Z},{default:w((()=>[I("确定")])),_:1}),_(le,{onClick:l[8]||(l[8]=e=>h(P)?P.value=!1:P=!1)},{default:w((()=>[I("取消")])),_:1})])])),_:1})])),_:1})),[[se,S(W)]])])),_:1},8,["modelValue","title"])],64)}}},[["__scopeId","data-v-e9d403f9"]]),P={class:"timeline-div"},W={class:"item-row"},$={key:0,class:"step-name-title"},G={class:"item-timestamp"},H={key:1,class:"item-content before"},Q={class:"item-title mb-5"},X={class:"item-step-name"},Y=["onClick"],K={key:2,class:"item-content"},Z={class:"contain-span"},ee={class:"item-title"},ae={key:0,class:"mr-5"},le={key:1,class:"mr-5"},te={key:0,style:{position:"relative",top:"2px",cursor:"pointer"}},oe={key:2,class:"mr-5"},ne={key:0,style:{position:"relative",top:"2px",cursor:"pointer"}},ie={key:3,class:"mr-5"},se={key:0,style:{position:"relative",top:"2px",cursor:"pointer"}},de=a({__name:"index",props:{modelValue:null,entityId:{type:String,default:""},title:{type:String,default:""}},emits:["update:modelValue","canner","confirm"],setup(a,{emit:o}){const n=a,i=e(),{queryEntityCodeById:s}=l(),d=v({1:"会签",2:"或签"});let u=p(!1),r=p(null);c((()=>n.modelValue),(()=>{r.value=n.modelValue}),{deep:!0}),c((()=>r.value),(e=>{o("update:modelValue",e)}),{deep:!0}),m((()=>{r.value=n.modelValue,async function(){u.value=!0;let e=await t.get("/approval/getTaskDetailsById",{entityId:n.entityId});e&&(N.value=function(e){let a=[];return e.forEach((e=>{e.needRow=1,e.singLabel=d[e.signType],a.push(e)})),a.forEach(((e,l)=>{a[l-1]&&e.currentNode==a[l-1].currentNode&&(e.needRow=1+a[l-1].needRow,a[l-1].singLabel=null)})),a}(e.data));u.value=!1}()}));let N=p([]);const T=(e,a)=>{if(0==e)return"primary";if([11,12].includes(a.state))return"warning";if([13].includes(a.state))return"danger";return[1].includes(a.state)?"info":"success"};function F(e,a){if(0===e)return null;let l=null;return a.stepName!=N.value[e-1].stepName&&(l=a.stepName),l}function j(e){let a=75*(e.needRow-1)+38;return{height:a+"px",lineHeight:a+"px",top:-75*(e.needRow-1)+"px"}}return(e,l)=>{const t=f("ElIconCircleCheck"),o=f("el-icon"),d=f("ElIconQuestionFilled"),p=f("el-tooltip"),c=f("el-tag"),m=f("el-timeline-item"),v=f("el-timeline"),B=f("el-empty"),E=f("mlDialog"),O=y("loading");return k(),x(E,{modelValue:S(r),"onUpdate:modelValue":l[0]||(l[0]=e=>h(r)?r.value=e:r=e),title:a.title,width:"35%"},{default:w((()=>[C((k(),g("div",P,[S(N).length>0?(k(),x(v,{key:0},{default:w((()=>[(k(!0),g(R,null,L(S(N),((e,a)=>(k(),x(m,{key:a,type:T(a,e),size:"large",class:"ml-timeline-item"},{default:w((()=>[b("div",W,[F(a,e)?(k(),g("div",$,V(F(a,e)),1)):U("",!0),b("div",G,V(e.createdOn),1),0==a?(k(),g("div",H,[b("div",Q,"由 "+V(e.stepUserName)+" 提交审批",1),b("div",X,[b("span",{class:"item-step-name-span",onClick:a=>(e=>{i.push({path:"/web/custom-page/approval-detail",query:{approvalConfigId:e.recordId,entityCode:s(n.entityId),look:1}})})(e)},[_(o,{class:"item-step-icon"},{default:w((()=>[_(t)])),_:1}),I(" "+V(e.stepName),1)],8,Y)])])):U("",!0),0!=a&&13!=e.state?(k(),g("div",K,[e.singLabel&&e.needRow>1?(k(),g("div",{key:0,class:"contain-div",style:A(j(e))},[b("span",Z,V(e.singLabel),1)],4)):U("",!0),b("div",ee,[0===e.state?(k(),g("span",ae,"等待 "+V(e.stepUserName)+" 审批",1)):U("",!0),1===e.state?(k(),g("span",le,[I(" 由 "+V(e.stepUserName)+" 审批同意 ",1),_(p,{effect:"dark",content:e.remark||"error",placement:"top"},{default:w((()=>[e.remark?(k(),g("span",te,[_(o,null,{default:w((()=>[_(d)])),_:1})])):U("",!0)])),_:2},1032,["content"])])):U("",!0),11===e.state?(k(),g("span",oe,[I(" 由 "+V(e.stepUserName)+" 驳回 ",1),_(p,{effect:"dark",content:e.remark||"error",placement:"top"},{default:w((()=>[e.remark?(k(),g("span",ne,[_(o,null,{default:w((()=>[_(d)])),_:1})])):U("",!0)])),_:2},1032,["content"])])):U("",!0),12===e.state?(k(),g("span",ie,[I(" 由 "+V(e.stepUserName)+" 撤销 ",1),_(p,{effect:"dark",content:e.remark||"error",placement:"top"},{default:w((()=>[e.remark?(k(),g("span",se,[_(o,null,{default:w((()=>[_(d)])),_:1})])):U("",!0)])),_:2},1032,["content"])])):U("",!0),1===e.operationState?(k(),x(c,{key:4,type:"warning"},{default:w((()=>[I("转审")])),_:1})):U("",!0),2===e.operationState?(k(),x(c,{key:5,type:"warning"},{default:w((()=>[I("加签")])),_:1})):U("",!0)])])):U("",!0)])])),_:2},1032,["type"])))),128))])),_:1})):(k(),x(B,{key:1,"image-size":100,description:"未查询到流程记录"}))])),[[O,S(u)]])])),_:1},8,["modelValue","title"])}}},[["__scopeId","data-v-a78dae42"]]),ue=(e=>(T("data-v-3bde1aed"),e=e(),F(),e))((()=>b("div",{class:"group-button-label"},"流程操作",-1))),re={key:1,class:"info-text"},pe={key:4},ce={key:5},me=a({__name:"ApprovalRelated",props:{approvalStatus:{type:Object,default:()=>{}}},emits:["onSubmit"],setup(a,{emit:l}){const o=a,n=e(),i=r("$API"),s=r("$TOOL");let d=p({});c((()=>o.approvalStatus),(()=>{d.value=o.approvalStatus}),{deep:!0}),m((()=>{d.value=o.approvalStatus}));let u=p([]),b=v({isShow:!1,loading:!1,title:"",approvalConfigId:""});const V=async e=>{b.isShow=!0,b.title=e,b.loading=!0;let a=await i.approval.detial.getApprovalList(d.value.recordId);a&&(u.value=a.data||[]),b.loading=!1},N=()=>{b.isShow=!1};let A=p(!1);const T=e=>{A.value=!0};let F=p(!1);const E=()=>{F.value=!0},O=()=>{l("onSubmit"),N()},D=()=>{j.confirm("是否确认撤销?","提示：",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((async()=>{b.loading=!0,await t.post("/approval/approvalRevocation?entityId="+d.value.recordId)&&(B.success("撤销成功"),l("onSubmit"),N()),b.loading=!1})).catch((()=>{}))},z=async()=>{if(!b.approvalConfigId)return void B.warning("请选择审批流程");b.loading=!0,await i.approval.detial.startApproval(d.value.recordId,b.approvalConfigId)&&(B.success("提交审批成功"),l("onSubmit"),N()),b.loading=!1},q=()=>{n.push("/web/process-list")};return(e,a)=>{const l=f("el-button"),t=f("el-row"),o=f("el-option"),n=f("el-select"),i=f("el-form-item"),r=f("el-form"),p=f("mlDialog"),c=y("loading");return k(),g(R,null,[ue,0==S(d).approvalStatus?(k(),x(t,{key:0},{default:w((()=>[S(d).startApproval?(k(),x(l,{key:0,type:"success",plain:"",onClick:a[0]||(a[0]=e=>V("提交审批"))},{default:w((()=>[I("提交审批")])),_:1})):U("",!0)])),_:1})):U("",!0),1==S(d).approvalStatus?(k(),g(R,{key:1},[_(t,null,{default:w((()=>[S(d).imApproval?(k(),x(l,{key:0,type:"success",plain:"",onClick:E},{default:w((()=>[I("审批")])),_:1})):U("",!0)])),_:1}),_(t,null,{default:w((()=>[_(l,{type:"success",plain:"",onClick:T},{default:w((()=>[I("审批历史")])),_:1})])),_:1})],64)):U("",!0),2==S(d).approvalStatus||4==S(d).approvalStatus?(k(),g(R,{key:2},[_(t,null,{default:w((()=>[_(l,{type:"success",plain:"",onClick:a[1]||(a[1]=e=>V("提交审批"))},{default:w((()=>[I("提交审批")])),_:1})])),_:1}),_(t,null,{default:w((()=>[_(l,{type:"success",plain:"",onClick:T},{default:w((()=>[I("审批历史")])),_:1})])),_:1})],64)):U("",!0),3==S(d).approvalStatus?(k(),g(R,{key:3},[_(t,null,{default:w((()=>[S(s).checkRole("r6013")?(k(),x(l,{key:0,type:"success",plain:"",onClick:D},{default:w((()=>[I("撤销审批")])),_:1})):U("",!0)])),_:1}),_(t,null,{default:w((()=>[_(l,{type:"success",plain:"",onClick:T},{default:w((()=>[I("审批历史")])),_:1})])),_:1})],64)):U("",!0),_(p,{modelValue:S(b).isShow,"onUpdate:modelValue":a[4]||(a[4]=e=>S(b).isShow=e),title:S(b).title,width:"460"},{default:w((()=>[C((k(),x(r,{"label-width":"120px"},{default:w((()=>[_(i,{label:"选择审批流程"},{default:w((()=>[S(u).length>0?(k(),x(n,{key:0,modelValue:S(b).approvalConfigId,"onUpdate:modelValue":a[2]||(a[2]=e=>S(b).approvalConfigId=e),placeholder:"请选择审批流程",style:{width:"233px","margin-bottom":"10px"}},{default:w((()=>[(k(!0),g(R,null,L(S(u),(e=>(k(),x(o,{key:e.approvalConfigId,label:e.flowName,value:e.approvalConfigId},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])):(k(),g("div",re,[I(" 暂无审批流程 "),S(s).checkRole("r30-1")?(k(),g("span",{key:0,class:"ml-a-span",onClick:q},"点击配置")):U("",!0)]))])),_:1}),_(i,null,{default:w((()=>[_(l,{type:"primary",style:{width:"80px"},onClick:z},{default:w((()=>[I("提交")])),_:1}),_(l,{style:{width:"80px"},onClick:a[3]||(a[3]=e=>S(b).isShow=!1)},{default:w((()=>[I("取消")])),_:1})])),_:1})])),_:1})),[[c,S(b).loading]])])),_:1},8,["modelValue","title"]),S(F)?(k(),g("div",pe,[_(M,{modelValue:S(F),"onUpdate:modelValue":a[5]||(a[5]=e=>h(F)?F.value=e:F=e),taskId:S(d).approvalTaskId,entityId:S(d).recordId,approvalName:S(d).approvalName,onConfirm:O,title:"审批"},null,8,["modelValue","taskId","entityId","approvalName"])])):U("",!0),S(A)?(k(),g("div",ce,[_(de,{modelValue:S(A),"onUpdate:modelValue":a[6]||(a[6]=e=>h(A)?A.value=e:A=e),entityId:S(d).recordId,title:"审批历史"},null,8,["modelValue","entityId"])])):U("",!0)],64)}}},[["__scopeId","data-v-3bde1aed"]]),ve=Object.freeze(Object.defineProperty({__proto__:null,default:me},Symbol.toStringTag,{value:"Module"}));export{me as A,de as a,ve as b,M as m};
