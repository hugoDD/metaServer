import{_ as e,q as t}from"./index-ea085229.js";import{u as i}from"./vue-router-414ebc36.js";import n from"./TriggerTakeAction-f05f2e3b.js";import o from"./PerformOperations-d8159cf3.js";import{b as a}from"./element-plus-bab58d46.js";import{R as r,r as l,v as s,a1 as p,l as m,Y as u,X as d,E as c,o as g,a as v,c as f,w as j,g as y,z as h,t as w,G as T,f as C,bh as b,bf as _}from"./@vue-1ad4818c.js";import"./vue3-manner-report-313033e6.js";import"./axios-85bcd05e.js";import"./crypto-js-43a3a23e.js";import"./@babel-6bd44fd1.js";import"./cron-parser-1391a961.js";import"./luxon-b01799b6.js";import"./nprogress-c04e6182.js";import"./pinia-3f60a8e1.js";import"./sortablejs-2f5483e3.js";import"./qrcodejs2-fix-bab07f30.js";import"./@element-plus-2a6d398c.js";import"./moment-bafe441d.js";import"./pinyin-pro-c81f5d39.js";import"./vue-i18n-0843b5c5.js";import"./@intlify-2528d766.js";import"./source-map-b06bd4b9.js";import"./vue-c723f8b1.js";import"./@vueuse-477b4dbb.js";import"./pinia-plugin-persistedstate-d2bd58cf.js";import"./resize-observer-polyfill-ad543aa3.js";import"./vue-smart-widget-8b3f5b0a.js";import"./echarts-b5d24e9a.js";import"./zrender-a15b073b.js";import"./tslib-a4e99503.js";import"./echarts-liquidfill-f5c863f1.js";import"./@antv-43d380be.js";import"./ant-design-vue-2db0c9af.js";import"./lodash-es-b8e8104a.js";import"./@ant-design-60f2ef8e.js";import"./@ctrl-4982d949.js";import"./dayjs-7fb79ad3.js";import"./vue-types-6bcea8eb.js";import"./dom-align-78cb5391.js";import"./vue-draggable-next-a413f884.js";import"./vue-resize-observer-90aea344.js";import"./@popperjs-b78c3215.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./escape-html-3148dbc9.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-0ef99041.js";import"./fieldUpdate-a79a141d.js";import"./index-b30b6746.js";import"./fieldAggregation-2ae494e5.js";import"./groupAggregation-76ef36dd.js";import"./autoCreation-8e398110.js";import"./dataValidation-cdeeeefd.js";import"./sendNotifications-1f73cded.js";import"./autoAllocation-ad2adbe5.js";import"./autoApproval-d939a6d5.js";import"./autoRevokeApproval-924e72e6.js";import"./autoDelete-77b73dbe.js";import"./hookUrl-74bdf60d.js";import"./autoShare-b6f3a3c4.js";const I=e=>(b("data-v-6c26ba65"),e=e(),_(),e),S={class:"trigger-header"},N=I((()=>y("span",{class:"trigger-title"},"触发器",-1))),k={class:"trigger-name"},A={class:"trigger-main"},U=I((()=>y("div",{class:"timeline-item-title"},"当发生动作",-1))),x=I((()=>y("div",{class:"timeline-item-title"},"就执行操作",-1))),O=I((()=>y("div",{style:{height:"10px"}},null,-1))),F={key:0,class:"save-success"},M=I((()=>y("div",{class:"mt-5 save-info"},"保存成功",-1))),V={class:"mt-20"},z={key:1,class:"save-warning"},E=I((()=>y("div",{class:"mt-5 save-info"},"计算公式可能存在错误，这会导致触发器执行失败。是否继续？",-1))),R={class:"mt-20"},q=e({__name:"trigger-detail",setup(e){const b=r("$ElMessage"),_=r("$API"),I=i();let q=l(!1),B=s({triggerConfigId:"",whenCron:null,actionContent:"",isOnSave:!1,disabledActive:[]});p((()=>{B.triggerConfigId=I.currentRoute.value.query.triggerConfigId,J()}));const J=async()=>{q.value=!0;let e=await t(B.triggerConfigId,"priority,entityCode,name,actionType,actionContent,whenNum,actionFilter,whenCron");e&&(B=Object.assign(B,e.data),B.priority=B.priority||1,B.actionContent=B.actionContent?JSON.parse(B.actionContent):{items:[]},B.actionFilter=B.actionFilter?JSON.parse(B.actionFilter):{items:[]},B.actionContent.items.length>0&&(B.isOnSave=!0),3==B.actionType.value&&B.actionContent.groupItem&&B.actionContent.groupItem.length>0&&(B.isOnSave=!0),4==B.actionType.value&&(B.disabledActive=[512]),6==B.actionType.value&&(B.disabledActive=[4,16,32,64,128,256,1024,2048]),9!=B.actionType.value&&10!=B.actionType.value||(B.disabledActive=[4,32,64]),8==B.actionType.value&&(B.disabledActive=[4])),q.value=!1},L=()=>{I.push({path:"/web/trigger-list"})};let D=s({isShow:!1,type:1});const G=async e=>{let{triggerConfigId:t,whenNum:i,priority:n,actionContent:o,defaultTargetEntity:a}=B;if(1==B.actionType.value&&o.items.length<1)return void b.warning("请至少添加 1 个更新规则");if(2==B.actionType.value&&o.items.length<1)return void b.warning("请至少添加 1 个聚合规则");let r={id:t,formModel:{triggerConfigId:t,priority:n,whenCron:null}};if(i>0&&!e){if((512&i)>0&&!B.whenCron)return void b.warning("请配置定期执行cron表达式");r.formModel.whenCron=B.whenCron}if(r.formModel.whenNum=i,r.formModel.actionFilter="",B.actionFilter.items.length>0&&(r.formModel.actionFilter=JSON.stringify(B.actionFilter)),2!=B.actionType.value&&1!=B.actionType.value&&3!=B.actionType.value&&15!=B.actionType.value||(o.entityName=a.entityName||a.name,o.fieldName=a.fieldName,o.isReferenced=a.isReferenced),3==B.actionType.value){let{groupItem:e}=o;if(e.length<1)return void b.warning("请至少添加一个分组字段关联")}if(4==B.actionType.value){if(o.filter.items.length<1)return void b.warning("请至少选择一个效验条件");if(!o.tipContent)return void b.warning("请填写提示内容")}if(5==B.actionType.value){let{type:e,title:t,content:i,outUserList:n,userType:a,inUserList:r}=o;if(3!=a&&e<1)return void b.warning("请至少选择一个通知类型");if(1==a&&r.length<1)return void b.warning("请选择要发送到的内部用户");if(2==a&&n.length<1)return void b.warning("请选择要发送到的外部人员");if(1==a?(o.sendTo=[],r.forEach((e=>{o.sendTo.push(e.id)}))):o.sendTo=n,(8&e)>0&&!t)return void b.warning("请输入邮件标题");if(!i)return void b.warning("请输入通知内容")}if(8==B.actionType.value){let{assignType:e,allocationWhos:t,cascades:i}=o;if(2==e&&t.length<1)return void b.warning("请选择分配给谁");2==e&&t.length>0&&(o.assignTo=[],t.forEach((e=>{o.assignTo.push(e.id)})))}if(7==B.actionType.value&&o.items.length<1)b.warning("请选择撤销记录");else if(9==B.actionType.value&&o.toUsersId.length<1)b.warning("请选择共享给谁");else if(10==B.actionType.value&&o.items.length<1)b.warning("请选择取消共享记录");else if(12==B.actionType.value&&o.items.length<1)b.warning("请选择删除记录");else{if(14==B.actionType.value){if("URL"==o.callBackType&&!o.hookUrl)return void b.warning("请输入要推送到的URL");if("FUNCTION"==o.callBackType&&!o.functionName)return void b.warning("请选择回调函数")}r.formModel.actionContent=JSON.stringify(o),"execute"!=e?(q.value=!0,await _.trigger.detial.triggerSave(r.id,r.formModel)&&(D.isShow=!0,D.type=1,B.isOnSave=!0),q.value=!1):P(r)}},P=e=>{a.confirm("此操作将直接执行此触发器，数据过多耗时会较长，请耐心等待。是否继续？?","",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{q.value=!0,await _.trigger.detial.execute({entityCode:B.entityCode,actionFilter:e.formModel.actionFilter||null,actionContent:e.formModel.actionContent||null,actionType:B.actionType.value,triggerConfigId:B.triggerConfigId}),q.value=!1})).catch((()=>{}))};return(e,t)=>{const i=m("el-header"),a=m("el-timeline-item"),r=m("el-timeline"),l=m("ElIconWarning"),s=m("el-icon"),p=m("el-button"),b=m("ml-dialog"),_=m("el-container"),I=u("loading");return d((g(),v("div",null,[f(_,null,{default:j((()=>[f(i,null,{default:j((()=>[y("div",S,[N,h(" / "),y("span",k,w(c(B).name),1)])])),_:1}),f(_,{class:"trigger-main-container"},{default:j((()=>[y("div",A,[f(r,null,{default:j((()=>[f(a,{type:"primary",hollow:""},{default:j((()=>[U,f(n,{modelValue:c(B),"onUpdate:modelValue":t[0]||(t[0]=e=>T(B)?B.value=e:B=e)},null,8,["modelValue"])])),_:1}),f(a,{type:"warning",hollow:""},{default:j((()=>[x,f(o,{modelValue:c(B),"onUpdate:modelValue":t[1]||(t[1]=e=>T(B)?B.value=e:B=e),onOnSave:G},null,8,["modelValue"])])),_:1}),f(a,null,{default:j((()=>[O])),_:1})])),_:1}),f(b,{modelValue:c(D).isShow,"onUpdate:modelValue":t[4]||(t[4]=e=>c(D).isShow=e),width:"500","not-header":"",top:"30vh"},{default:j((()=>[1==c(D).type?(g(),v("div",F,[y("div",null,[f(s,{class:"save-icon",size:"50"},{default:j((()=>[f(l)])),_:1})]),M,y("div",V,[f(p,{onClick:L},{default:j((()=>[h("返回列表")])),_:1}),f(p,{type:"primary",onClick:t[2]||(t[2]=e=>c(D).isShow=!1)},{default:j((()=>[h("继续编辑")])),_:1})])])):C("",!0),2==c(D).type?(g(),v("div",z,[y("div",null,[f(s,{class:"save-icon",size:"50"},{default:j((()=>[f(l)])),_:1})]),E,y("div",R,[f(p,{onClick:t[3]||(t[3]=t=>{e.notTitleDialogIsShow=!1})},{default:j((()=>[h("取消")])),_:1}),f(p,{type:"warning",onClick:e.test1},{default:j((()=>[h("确定")])),_:1},8,["onClick"])])])):C("",!0)])),_:1},8,["modelValue"])])])),_:1})])),_:1})])),[[I,c(q)]])}}},[["__scopeId","data-v-6c26ba65"]]);export{q as default};
