import{_ as e,ax as t,Q as i,ay as o,h as s,az as a,aA as n}from"./index-ea085229.js";import r from"./boolean-widget-editor-96decc00.js";import d from"./integer-widget-editor-fc7736e2.js";import l from"./decimal-widget-editor-3bf7f1a6.js";import p from"./percent-widget-editor-efe2ad39.js";import m from"./money-widget-editor-8dc26d51.js";import u from"./text-widget-editor-dca21c09.js";import c from"./email-widget-editor-e06c216a.js";import f from"./url-widget-editor-8378b1cc.js";import g from"./textarea-widget-editor-303cffa1.js";import h from"./password-widget-editor-c0cc48b6.js";import y from"./option-widget-editor-e6a9a4fe.js";import D from"./tag-widget-editor-b8304c3f.js";import w from"./areaselect-widget-editor-472a3859.js";import F from"./date-widget-editor-f841f5a7.js";import j from"./datetime-widget-editor-0eebeda4.js";import v from"./picture-widget-editor-4d3f953b.js";import W from"./file-widget-editor-8dad7fe9.js";import E from"./reference-widget-editor-7831b5c0.js";import b from"./anyreference-widget-editor-6ab813ca.js";import S from"./referencelist-widget-editor-2cb31426.js";import{l as L,o as T,a as x,c as M,w as R,z as N,i as C,j as U,f as _,F as P}from"./@vue-1ad4818c.js";import"./element-plus-bab58d46.js";import"./lodash-es-b8e8104a.js";import"./@vueuse-477b4dbb.js";import"./@element-plus-2a6d398c.js";import"./@babel-6bd44fd1.js";import"./@popperjs-b78c3215.js";import"./@ctrl-4982d949.js";import"./dayjs-7fb79ad3.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./escape-html-3148dbc9.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-0ef99041.js";import"./vue3-manner-report-313033e6.js";import"./axios-85bcd05e.js";import"./crypto-js-43a3a23e.js";import"./cron-parser-1391a961.js";import"./luxon-b01799b6.js";import"./vue-router-414ebc36.js";import"./nprogress-c04e6182.js";import"./pinia-3f60a8e1.js";import"./sortablejs-2f5483e3.js";import"./qrcodejs2-fix-bab07f30.js";import"./moment-bafe441d.js";import"./pinyin-pro-c81f5d39.js";import"./vue-i18n-0843b5c5.js";import"./@intlify-2528d766.js";import"./source-map-b06bd4b9.js";import"./vue-c723f8b1.js";import"./pinia-plugin-persistedstate-d2bd58cf.js";import"./resize-observer-polyfill-ad543aa3.js";import"./vue-smart-widget-8b3f5b0a.js";import"./echarts-b5d24e9a.js";import"./zrender-a15b073b.js";import"./tslib-a4e99503.js";import"./echarts-liquidfill-f5c863f1.js";import"./@antv-43d380be.js";import"./ant-design-vue-2db0c9af.js";import"./@ant-design-60f2ef8e.js";import"./vue-types-6bcea8eb.js";import"./dom-align-78cb5391.js";import"./vue-draggable-next-a413f884.js";import"./vue-resize-observer-90aea344.js";import"./field-state-variables-3bb6d4cb.js";import"./field-editor-mixin-140fe671.js";const $={Boolean:{type:"radio",options:{}},Text:{type:"input",options:{}},Email:{type:"input",options:{}},Url:{type:"input",options:{}},Password:{type:"input",options:{type:"password",showPassword:!0}},TextArea:{type:"textarea",options:{}},Integer:{type:"number",options:{precision:0,step:1,controls:!0}},Decimal:{type:"number",options:{precision:2,controls:!1}},Percent:{type:"number",options:{precision:0,step:1,controls:!0}},Money:{type:"number",options:{precision:2,controls:!1}},Date:{type:"date",options:{type:"date",format:"YYYY-MM-DD",valueFormat:"YYYY-MM-DD"}},DateTime:{type:"date",options:{type:"datetime",format:"YYYY-MM-DD HH:mm:ss",valueFormat:"YYYY-MM-DD HH:mm:ss"}},Option:{type:"select",options:{multiple:!1}},MultiOption:{type:"select",options:{multiple:!0}},Status:{type:"select",options:{disabled:!0}},Tag:{type:"check-tag",options:{}},Picture:{type:"picture-upload",options:{uploadURL:"DSV['uploadServer'] + '/picture/upload'",withCredentials:!0}},File:{type:"file-upload",options:{uploadURL:"DSV['uploadServer'] + '/file/upload'",withCredentials:!0}},AreaSelect:{type:"cascader",options:{areaDataEnabled:!0,areaDataType:2}},Reference:{type:"reference",options:{}},AnyReference:{type:"any-reference",options:{}},ReferenceList:{type:"reference-list",options:{}}};const k=e({name:"form-design",components:{BooleanWE:r,IntegerWE:d,DecimalWE:l,PercentWE:p,MoneyWE:m,TextWE:u,EmailWE:c,UrlWE:f,TextAreaWE:g,PasswordWE:h,OptionWE:y,TagWE:D,AreaSelectWE:w,DateWE:F,DateTimeWE:j,PictureWE:v,FileWE:W,ReferenceWE:E,AnyReferenceWE:b,ReferenceListWE:S},prop:{entity:{type:String},entityLabel:{type:String}},data:()=>({designerConfig:{componentLib:!1,formTemplates:!1,eventCollapse:!1,metadataLib:!0,logoHeader:!1,exportCodeButton:!1,generateSFCButton:!1,toolbarMaxWidth:300},fieldListData:{},layoutId:null,formOptionData:{},meteFieldsResult:null,usedFieldNames:{},curFWEditor:"",curEditorType:"",showNewFieldDialogFlag:!1}),created(){this.entity=this.$route.query.entity,this.entityLabel=this.$route.query.entityLabel,this.designerConfig.componentLib=!!window.advancedDevMode,this.designerConfig.eventCollapse=!!window.advancedDevMode},mounted(){this.loadDesign(),this.handleDocumentKeyEvent()},methods:{handleDocumentKeyEvent(){let e=0,t=0,i=0,o=0;document.onkeydown=s=>{let a=s.keyCode||s.which||s.charCode;16===a?e=1:18===a?t=1:76===a||108===a?o=1:77!==a&&109!==a||(i=1),e&&t&&i&&o&&(window.advancedDevMode=!window.advancedDevMode,this.designerConfig.componentLib=!!window.advancedDevMode,this.designerConfig.eventCollapse=!!window.advancedDevMode)},document.onkeyup=s=>{let a=s.keyCode||s.which||s.charCode;16===a?e=0:18===a?t=0:76===a||108===a?o=0:77!==a&&109!==a||(i=0)}},loadFieldListData(){t(this.entity).then((e=>{if(e.data.fieldList){this.fieldListData.fieldList=e.data.fieldList,e.data.subFormList&&(this.fieldListData.subFormList=e.data.subFormList),this.meteFieldsResult=e;const t=this.buildMetaFields(this.meteFieldsResult);this.$refs.vfDesigner.setFieldListData(this.fieldListData),this.$refs.vfDesigner.setMetaFields(t)}})).catch((e=>{this.$message({message:e.message,type:"error"})}))},buildMetaFields(e){const t={main:{entityName:this.entity,entityLabel:this.entityLabel,fieldList:[]},detail:[]};return e.data.fieldList&&e.data.fieldList.forEach((s=>{if(!s.detailEntity&&"PrimaryKey"!==s.type){if("loginPwd"===s.name)return;if("AnyReference"===s.type||"ReferenceList"===s.type)return;if(this.usedFieldNames.hasOwnProperty(s.name))return;const a=i($[s.type]),n=i(this.$refs.vfDesigner.designer.getFieldWidgetByType(a.type));o(n.options,a.options),n.displayName=s.label,n.nameReadonly=!0,n.options.name=s.name,n.options.label=s.label,this.adjustFieldSchema(n,s,e),t.main.fieldList.push(n)}})),e.data.subFormList&&e.data.subFormList.forEach((s=>{const a=s.name,n=s.label,r={entityName:a,entityLabel:n,fieldList:[]};e.data.fieldList.forEach((t=>{if(t.detailEntity&&t.detailEntity===a&&"PrimaryKey"!==t.type){if("AnyReference"===t.type||"ReferenceList"===t.type)return;if(this.usedFieldNames.hasOwnProperty(t.name))return;const s=i($[t.type]),a=i(this.$refs.vfDesigner.designer.getFieldWidgetByType(s.type));o(a.options,s.options),a.displayName=t.label,a.nameReadonly=!0,a.options.name=t.name,a.options.label=t.label,this.adjustFieldSchema(a,t,e),r.fieldList.push(a)}})),t.detail.push(r)})),t},adjustFieldSchema(e,t,o){let s=!1;o.data.storageSetting&&(s="true"===o.data.storageSetting[0].cloudStorage,s&&o.data.storageSetting[0].cloudStorageType),"Picture"!==t.type&&"File"!==t.type||s&&(e.options.withCredentials=!1,e.options.onBeforeUpload="const gDSV = this.getGlobalDsv();\nconst wType = this.field.type;\nif (wType === 'picture-upload') {\n  this.field.options.uploadURL = gDSV.picUploadURL;\n} else if (wType === 'file-upload')  {\n  this.field.options.uploadURL = gDSV.fileUploadURL;\n}\n\nconst cloudStorage = gDSV.cloudStorage;\nif (cloudStorage === \"true\") {\n  this.field.options.withCredentials = false\n  const token = gDSV.cloudUploadToken;\n  this.setUploadData('token', token);\n  \n  const randomNum = Math.floor(Math.random() * 100);\n  const newFileName = new Date().getTime() + randomNum+ '_' + file.name;\n  this.setUploadData('key', newFileName);\n} else {\n  //this.field.options.withCredentials = true\n}\n",e.options.onUploadSuccess="const gDSV = this.getGlobalDsv();\nconst cloudStorage = gDSV.cloudStorage;\nif (cloudStorage === \"true\") {\n  const wType = this.field.type;\n  let downloadPrefix = \"\"\n  if (wType === 'picture-upload') {\n    downloadPrefix = gDSV.picDownloadPrefix;\n  } else if (wType === 'file-upload')  {\n    downloadPrefix = gDSV.fileDownloadPrefix;\n  }\n  \n  let downUrl = downloadPrefix + result.key;\n  const paramName = (downUrl.indexOf(\"?\") === -1) ? '?fileName=' : '&fileName=';\n  return {\n    name: file.name,\n    url: downUrl + paramName + file.name\n  }\n} else {\n  const paramName = (result.url.indexOf(\"?\") === -1) ? '?fileName=' : '&fileName=';\n  return {\n    name: file.name,\n    url: result.url + paramName + file.name\n  }\n}\n"),"Integer"!==t.type&&"Percent"!==t.type&&"Money"!==t.type&&"Decimal"!==t.type||(e.options.precision=t.precision?1*t.precision:e.options.precision,e.options.min=t.min?1*t.min:e.options.min,e.options.max=t.max?1*t.max:e.options.max),"AreaSelect"===t.type&&(e.optionItemsReadonly=!0,e.options.areaDataType=t.areaDataType?1*t.areaDataType:e.options.areaDataType),"Reference"===t.type&&(e.options.searchDialogWidth=t.searchDialogWidth?t.searchDialogWidth:e.options.searchDialogWidth),e.options.hasOwnProperty("optionItems")&&(this.formOptionData.hasOwnProperty(e.options.name)&&(e.options.optionItems=i(this.formOptionData[e.options.name])),"Boolean"===t.type&&(e.options.optionItems=[{value:!0,label:"是"},{value:!1,label:"否"},{value:null,label:"未指定"}]),e.optionItemsReadonly=!0),t.hasOwnProperty("required")&&(e.options.required="1"===t.required)},handleFWU(e){this.usedFieldNames[e]=1,setTimeout((()=>{const e=this.buildMetaFields(this.meteFieldsResult);this.$refs.vfDesigner.setMetaFields(e)}),800)},handleFWR(e){delete this.usedFieldNames[e],setTimeout((()=>{const e=this.buildMetaFields(this.meteFieldsResult);this.$refs.vfDesigner.setMetaFields(e)}),800)},handleFJU(){this.handleUsedFields(),setTimeout((()=>{const e=this.buildMetaFields(this.meteFieldsResult);this.$refs.vfDesigner.setMetaFields(e)}),300)},handleUsedFields(){this.usedFieldNames={};this.$refs.vfDesigner.getFieldWidgets().forEach((e=>{this.usedFieldNames[e.name]=1}))},loadDesign(){s(this.entity).then((e=>{null==e.error?(e.data&&e.data.layoutJson?(this.layoutId=e.data.formLayoutId,this.$refs.vfDesigner.setFormJson(e.data.layoutJson),this.handleUsedFields()):this.$refs.vfDesigner.clearDesigner(),e.data&&e.data.optionData&&(this.formOptionData=e.data.optionData,this.$refs.vfDesigner.setTestOptionData(e.data.optionData)),this.loadFieldListData()):this.$message({message:e.error,type:"error"})})).catch((e=>{this.$message({message:e.message,type:"error"})}))},saveDesign(){this.layoutId?n(this.layoutId,this.$refs.vfDesigner.getFormJson()).then((e=>{null!=e.error?this.$message({message:e.error,type:"error"}):this.$message.success("保存成功")})).catch((e=>{this.$message({message:e.message,type:"error"})})):a(this.entity,this.$refs.vfDesigner.getFormJson()).then((e=>{null==e.error?(this.layoutId=e.data,this.$message.success("保存成功")):this.$message({message:e.error,type:"error"})})).catch((e=>{this.$message({message:e.message,type:"error"})}))},handleNewFieldCommand(e){this.curFWEditor=e,this.curEditorType=e.replace(/WE$/,""),this.showNewFieldDialogFlag=!0},onFieldSaved(){this.showNewFieldDialogFlag=!1,setTimeout((()=>{this.loadFieldListData()}),300)},onCancelSaveField(){this.showNewFieldDialogFlag=!1}}},[["render",function(e,t,i,o,s,a){const n=L("MagicStick"),r=L("el-icon"),d=L("el-button"),l=L("el-dropdown-item"),p=L("el-dropdown-menu"),m=L("el-dropdown"),u=L("Finished"),c=L("v-form-designer"),f=L("el-dialog");return T(),x(P,null,[M(c,{ref:"vfDesigner","designer-config":s.designerConfig,"field-list-data":s.fieldListData,onFieldWidgetUsed:a.handleFWU,onFieldWidgetRemoved:a.handleFWR,onFormJsonUpdated:a.handleFJU,class:"visual-design"},{customToolButtons:R((()=>[M(m,{class:"ml-button-dropdown",onCommand:a.handleNewFieldCommand,size:"small"},{dropdown:R((()=>[M(p,null,{default:R((()=>[M(l,{command:"BooleanWE"},{default:R((()=>[N("布尔 / Boolean")])),_:1}),M(l,{command:"IntegerWE"},{default:R((()=>[N("整数 / Integer")])),_:1}),M(l,{command:"DecimalWE"},{default:R((()=>[N("精度小数 / Decimal")])),_:1}),M(l,{command:"PercentWE"},{default:R((()=>[N("百分比 / Percent")])),_:1}),M(l,{command:"MoneyWE"},{default:R((()=>[N("金额 / Money")])),_:1}),M(l,{command:"TextWE",divided:""},{default:R((()=>[N("文本 / Text")])),_:1}),M(l,{command:"TextAreaWE"},{default:R((()=>[N("长文本 / TextArea")])),_:1}),M(l,{command:"OptionWE",divided:""},{default:R((()=>[N("单选项 / Option")])),_:1}),M(l,{command:"TagWE"},{default:R((()=>[N("多选项 / Tag")])),_:1}),M(l,{command:"AreaSelectWE"},{default:R((()=>[N("地区选择 / AreaSelect")])),_:1}),M(l,{command:"DateWE",divided:""},{default:R((()=>[N("日期 / Date")])),_:1}),M(l,{command:"DateTimeWE"},{default:R((()=>[N("日期时间 / DateTime")])),_:1}),M(l,{command:"PictureWE",divided:""},{default:R((()=>[N("图片 / Picture")])),_:1}),M(l,{command:"FileWE"},{default:R((()=>[N("文件 / File")])),_:1}),M(l,{command:"ReferenceWE",divided:""},{default:R((()=>[N("一对一引用 / Reference")])),_:1})])),_:1})])),default:R((()=>[M(d,{link:"",type:"primary"},{default:R((()=>[M(r,null,{default:R((()=>[M(n)])),_:1}),N("新建字段 ")])),_:1})])),_:1},8,["onCommand"]),M(d,{type:"primary",link:"",onClick:a.saveDesign},{default:R((()=>[M(r,null,{default:R((()=>[M(u)])),_:1}),N(" 保存设计 ")])),_:1},8,["onClick"])])),_:1},8,["designer-config","field-list-data","onFieldWidgetUsed","onFieldWidgetRemoved","onFormJsonUpdated"]),s.showNewFieldDialogFlag?(T(),C(f,{key:0,title:"新建字段 / "+s.curEditorType,modelValue:s.showNewFieldDialogFlag,"onUpdate:modelValue":t[0]||(t[0]=e=>s.showNewFieldDialogFlag=e),"show-close":!0,"destroy-on-close":!0,"close-on-click-modal":!1,"close-on-press-escape":!1,class:"no-padding",width:"620px"},{default:R((()=>[(T(),C(U(s.curFWEditor),{entity:e.entity,onFieldSaved:a.onFieldSaved,onCancelSave:a.onCancelSaveField,showingInDialog:!0},null,40,["entity","onFieldSaved","onCancelSave"]))])),_:1},8,["title","modelValue"])):_("",!0)],64)}],["__scopeId","data-v-f0a85b4b"]]);export{k as default};
