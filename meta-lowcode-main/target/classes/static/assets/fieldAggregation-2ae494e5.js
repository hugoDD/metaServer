import{_ as e,n as l}from"./index-ea085229.js";import{m as a}from"./index-b30b6746.js";import{R as t,r as o,p as i,v as u,l as s,Y as n,X as r,E as d,o as m,a as c,c as p,w as v,F as f,A as g,i as b,z as y,g as j,t as C,e as F,f as h,G as N,bh as _,bf as V}from"./@vue-1ad4818c.js";import"./element-plus-bab58d46.js";import"./lodash-es-b8e8104a.js";import"./@vueuse-477b4dbb.js";import"./@element-plus-2a6d398c.js";import"./@babel-6bd44fd1.js";import"./@popperjs-b78c3215.js";import"./@ctrl-4982d949.js";import"./dayjs-7fb79ad3.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./escape-html-3148dbc9.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-0ef99041.js";import"./vue3-manner-report-313033e6.js";import"./axios-85bcd05e.js";import"./crypto-js-43a3a23e.js";import"./cron-parser-1391a961.js";import"./luxon-b01799b6.js";import"./vue-router-414ebc36.js";import"./nprogress-c04e6182.js";import"./pinia-3f60a8e1.js";import"./sortablejs-2f5483e3.js";import"./qrcodejs2-fix-bab07f30.js";import"./moment-bafe441d.js";import"./pinyin-pro-c81f5d39.js";import"./vue-i18n-0843b5c5.js";import"./@intlify-2528d766.js";import"./source-map-b06bd4b9.js";import"./vue-c723f8b1.js";import"./pinia-plugin-persistedstate-d2bd58cf.js";import"./resize-observer-polyfill-ad543aa3.js";import"./vue-smart-widget-8b3f5b0a.js";import"./echarts-b5d24e9a.js";import"./zrender-a15b073b.js";import"./tslib-a4e99503.js";import"./echarts-liquidfill-f5c863f1.js";import"./@antv-43d380be.js";import"./ant-design-vue-2db0c9af.js";import"./@ant-design-60f2ef8e.js";import"./vue-types-6bcea8eb.js";import"./dom-align-78cb5391.js";import"./vue-draggable-next-a413f884.js";import"./vue-resize-observer-90aea344.js";const w=e=>(_("data-v-544eb9d3"),e=e(),V(),e),M={class:"action-div"},x={key:0,class:"w-100 mb-10"},k={class:"uptade-rule-span"},E={class:"uptade-rule-span"},T=["onClick"],A=w((()=>j("div",{class:"w-100 info-text mt-3"},"目标字段",-1))),S=w((()=>j("div",{class:"w-100 info-text mt-3"},"聚合方式",-1))),z={key:2,class:"w-100 info-text mt-3"},U=w((()=>j("div",{class:"info-text"},"仅会聚合符合过滤条件的数据",-1))),I={key:0},L={key:1},$=e({__name:"fieldAggregation",props:{modelValue:null},setup(e){const _=e,V=t("$API"),w=t("$ElMessage");let $=o(!1),q=o({actionContent:{}});i((()=>{q.value=_.modelValue,q.value.actionContent.filter||(q.value.actionContent.filter={items:[]}),G()}));let O=o([]),D=o([]),P=o({}),J=o([]),R=o({}),B=o(!1);const G=async()=>{$.value=!0;let{value:e}=q.value.actionType;1!=e&&2!=e||Promise.all([H(),K()]).then((()=>{if($.value=!1,O.value.length>0){let e=0;if(q.value.isOnSave){let{actionContent:l}=q.value;O.value.forEach(((a,t)=>{a.fieldName==l.fieldName&&a.entityName==l.entityName&&(e=t)}))}q.value.defaultTargetEntity=O.value[e],X(O.value[e].entityCode)}}))},H=()=>new Promise((async(e,l)=>{let a=await V.trigger.detial.aggregationEntityList(q.value.entityCode);a&&a.data&&(O.value=a.data.map(((e,l)=>(e.entityInx=l,e)))),e()})),K=()=>new Promise((async(e,a)=>{let t=await l(q.value.entityCode,!0,!0);t&&(J.value=t.data,t.data.forEach((e=>{R.value[e.fieldName]=e.fieldLabel}))),e()})),X=async e=>{var a;B.value=!0;let t=await l(e);t&&(D.value=[],t.data.forEach((e=>{e.fieldType&&pe.value.includes(e.fieldType)&&(P.value[e.fieldName]=e.fieldLabel,D.value.push(e))})),D.value.length>0?(Y.value=D.value[0],Z.targetField=D.value[0].fieldName,W.value=je(D.value[0].fieldName),Z.calcMode=le()[0].value,"forCompile"!==Z.calcMode&&(Z.sourceField=null==(a=Ce()[0])?void 0:a.fieldName),re()):(Y.value={},Z.targetField="",Z.calcMode="",Z.sourceField="")),B.value=!1};let Y=o({}),Z=u({targetField:"",calcMode:"",sourceField:"",simpleFormula:!1});const Q=u({forCompile:"计算公式",concatSet:"去重拼接",concat:"拼接",min:"最小值",max:"最大值",average:"平均值",countSet:"去重计数",count:"计数",sum:"求和"});let W=o("");const ee=e=>{var l;Z.targetField=e.fieldName,W.value=je(e.fieldName),Z.calcMode=le()[0].value,"forCompile"!==Z.calcMode?Z.sourceField=null==(l=Ce()[0])?void 0:l.fieldName:Z.sourceField=""},le=()=>pe.value.includes(W.value)?[{label:"求和",value:"sum"},{label:"计数",value:"count"},{label:"去重计数",value:"countSet"},{label:"平均值",value:"average"},{label:"最大值",value:"max"},{label:"最小值",value:"min"},{label:"计算公式",value:"forCompile"}]:[{label:"计数",value:"count"},{label:"去重计数",value:"countSet"},{label:"拼接",value:"concat"},{label:"去重拼接",value:"concatSet"},{label:"计算公式",value:"forCompile"}],ae=e=>{var l;Z.sourceField="forCompile"!=e?null==(l=Ce()[0])?void 0:l.fieldName:""};let te=o([]);const oe=()=>{let{targetField:e,calcMode:l,sourceField:a,simpleFormula:t,updateMode:o}=Z;if(!e)return;if("toNull"!=o&&!a)return;if(q.value.actionContent.fieldName+"."+e==a)return void w.warning("目标字段与源字段不能为同一字段!");if(q.value.actionContent.items.filter((l=>l.targetField==e)).length>0)return void w.warning("目标字段重复!");let i="";"forCompile"!=l||t||(i=fe.value),q.value.actionContent.items.push({targetField:e,calcMode:l,sourceField:i||a,simpleFormula:t}),te.value.push({targetField:ie(e),calcMode:ue(l),sourceField:se(Z),simpleFormula:t}),"forCompile"==l&&(Z.sourceField="")},ie=e=>P.value[e],ue=e=>Q[e],se=e=>"forCompile"==e.calcMode?e.simpleFormula?e.sourceField:ne(e.sourceField):R.value[e.sourceField],ne=e=>{let l=e,a=l.match(/{([a-zA-Z0-9$\.]+)}/g);return a?(a.forEach((e=>{let a=e.substring(1);a=a.substring(0,a.length-1);let t=a.split("$"),o=`{${R.value[t[0]]}(${Q[t[1]]})}`;l=l.replace(e,o)})),l):l},re=()=>{te.value=[],q.value.actionContent.items.forEach((e=>{te.value.push({targetField:ie(e.targetField),calcMode:ue(e.calcMode),sourceField:se(e),simpleFormula:e.simpleFormula})}))};let de=o(!1),me=o([]),ce=o(""),pe=o(["Integer","Decimal","Percent","Money"]);o(["Text","TextArea"]);let ve=o(!1),fe=o({});const ge=()=>{be(J.value,!0,Z.sourceField)},be=(e,l,a)=>{de.value=!0,me.value=e,ve.value=l,ce.value=l?a:"",Z.simpleFormula=l},ye=e=>{fe.value=e,Z.sourceField=e.label},je=e=>D.value.filter((l=>l.fieldName==e))[0].fieldType,Ce=()=>{if(["sum","average","max","min"].includes(Z.calcMode)){let e=[];return J.value.forEach((l=>{pe.value.includes(l.fieldType)&&e.push(l)})),e}return J.value};let Fe=o(!1),he=o({});const Ne=()=>{let{filter:e}=q.value.actionContent;e=_e(e),he.value=JSON.parse(JSON.stringify(e)),Fe.value=!0},_e=e=>{let{equation:l}=e;return l&&"OR"!==l?"AND"===l?(e.type=2,e.equation="AND"):e.type=3:(e.type=1,e.equation="OR"),e},Ve=()=>{let{filter:e}=q.value.actionContent,l=e&&e.items?e.items.length:0;return l>0?`已设置条件（${l}）`:"点击设置"},we=e=>{q.value.actionContent.filter=e,Fe.value=!1},Me=()=>{let e=q.value.defaultTargetEntity;q.value.actionContent.entityName=e.entityName,q.value.actionContent.fieldName=e.fieldName,q.value.actionContent.items=[],e.entityCode?X(e.entityCode):(D.value=J.value,Y.value=D.value[0])};return(e,l)=>{const t=s("el-option"),o=s("el-select"),i=s("el-col"),u=s("el-row"),_=s("el-form-item"),V=s("ElIconCloseBold"),w=s("el-icon"),P=s("el-input"),J=s("el-button"),R=s("mlSetConditions"),G=s("mlDialog"),H=n("loading");return r((m(),c("div",M,[p(_,{label:"目标实体"},{default:v((()=>[p(u,{class:"w-100 mb-15",gutter:20},{default:v((()=>[p(i,{span:9},{default:v((()=>[p(o,{modelValue:d(q).defaultTargetEntity,"onUpdate:modelValue":l[0]||(l[0]=e=>d(q).defaultTargetEntity=e),filterable:"",class:"w-100",onChange:Me,disabled:d(q).isOnSave,"value-key":"entityInx"},{default:v((()=>[(m(!0),c(f,null,g(d(O),((e,l)=>(m(),b(t,{key:l,label:e.label,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})])),_:1})])),_:1}),p(_,null,{label:v((()=>[y("聚合规则")])),default:v((()=>[d(te).length>0?(m(),c("div",x,[(m(!0),c(f,null,g(d(te),((e,l)=>(m(),b(u,{gutter:20,class:"uptade-rule-row w-100 mb-5",key:l},{default:v((()=>[p(i,{span:9},{default:v((()=>[j("span",k,C(e.targetField),1)])),_:2},1024),p(i,{span:5},{default:v((()=>[j("span",E,C(e.calcMode),1)])),_:2},1024),p(i,{span:9,class:"uptade-rule-col-last"},{default:v((()=>[j("span",{class:F(["uptade-rule-span",{toFixed:"toFixed"==e.calcMode,forCompile:"forCompile"==e.calcMode}])},[y(C(e.sourceField)+" ",1),j("span",{class:"del-icon",onClick:e=>(e=>{q.value.actionContent.items.splice(e,1),te.value.splice(e,1)})(l)},[p(w,null,{default:v((()=>[p(V)])),_:1})],8,T)],2)])),_:2},1024)])),_:2},1024)))),128))])):h("",!0),r((m(),b(u,{class:"w-100 mb-10 uptade-rule",gutter:20},{default:v((()=>[p(i,{span:9},{default:v((()=>[p(o,{modelValue:d(Y),"onUpdate:modelValue":l[1]||(l[1]=e=>N(Y)?Y.value=e:Y=e),filterable:"",class:"w-100",onChange:ee,"value-key":"fieldLabel"},{default:v((()=>[(m(!0),c(f,null,g(d(D),((e,l)=>(m(),b(t,{key:l,label:e.fieldLabel,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),A])),_:1}),p(i,{span:5},{default:v((()=>[p(o,{modelValue:d(Z).calcMode,"onUpdate:modelValue":l[2]||(l[2]=e=>d(Z).calcMode=e),class:"w-100",onChange:ae},{default:v((()=>[(m(!0),c(f,null,g(le(),((e,l)=>(m(),b(t,{key:l,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),S])),_:1}),p(i,{span:9},{default:v((()=>["forCompile"!==d(Z).calcMode?(m(),b(o,{key:0,modelValue:d(Z).sourceField,"onUpdate:modelValue":l[3]||(l[3]=e=>d(Z).sourceField=e),filterable:"",class:"w-100"},{default:v((()=>[(m(!0),c(f,null,g(Ce(),((e,l)=>(m(),b(t,{key:l,label:e.fieldLabel,value:e.fieldName},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])):(m(),b(P,{key:1,modelValue:d(Z).sourceField,"onUpdate:modelValue":l[4]||(l[4]=e=>d(Z).sourceField=e),placeholder:"计算公式",autosize:"",type:"textarea",onClick:ge},null,8,["modelValue"])),"toNull"!==d(Z).calcMode?(m(),c("div",z,C("forCompile"==Z.calcMode?"计算公式":"聚合字段"),1)):h("",!0)])),_:1})])),_:1})),[[H,d(B)]])])),_:1}),p(_,{label:" "},{default:v((()=>[p(J,{type:"primary",plain:"",onClick:oe},{default:v((()=>[y("+ 添加")])),_:1})])),_:1}),p(_,{class:"mt-20",label:"聚合数据条件"},{default:v((()=>[p(u,null,{default:v((()=>[p(i,{span:24},{default:v((()=>[j("span",{class:"ml-a-span",onClick:Ne},C(Ve()),1)])),_:1}),p(i,{span:24},{default:v((()=>[U])),_:1})])),_:1})])),_:1}),d(de)?(m(),c("div",I,[p(a,{modelValue:d(de),"onUpdate:modelValue":l[5]||(l[5]=e=>N(de)?de.value=e:de=e),fields:d(me),defaultFormulaVal:d(ce),isAdvanced:d(ve),onConfirm:ye},null,8,["modelValue","fields","defaultFormulaVal","isAdvanced"])])):h("",!0),d(Fe)?(m(),c("div",L,[p(G,{title:"聚合数据条件","append-to-body":"",width:"37%",modelValue:d(Fe),"onUpdate:modelValue":l[8]||(l[8]=e=>N(Fe)?Fe.value=e:Fe=e)},{default:v((()=>[p(R,{modelValue:d(he),"onUpdate:modelValue":l[6]||(l[6]=e=>N(he)?he.value=e:he=e),footer:"",onCancel:l[7]||(l[7]=e=>N(Fe)?Fe.value=!1:Fe=!1),onConfirm:we,entityName:d(q).entityCode},null,8,["modelValue","entityName"])])),_:1},8,["modelValue"])])):h("",!0)])),[[H,d($)]])}}},[["__scopeId","data-v-544eb9d3"]]);export{$ as default};
