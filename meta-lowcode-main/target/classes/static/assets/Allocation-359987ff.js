import{u as e}from"./vue-router-414ebc36.js";import{_ as l,o as a,p as s,r as t,t as o}from"./index-ea085229.js";import{R as i,r as d,v as r,l as p,Y as m,o as u,i as c,w as n,c as y,z as b,G as j,E as v,X as f,a as g,t as h,f as V,g as T,F as k,A as w}from"./@vue-1ad4818c.js";import"./element-plus-bab58d46.js";import"./lodash-es-b8e8104a.js";import"./@vueuse-477b4dbb.js";import"./@element-plus-2a6d398c.js";import"./@babel-6bd44fd1.js";import"./@popperjs-b78c3215.js";import"./@ctrl-4982d949.js";import"./dayjs-7fb79ad3.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./escape-html-3148dbc9.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-0ef99041.js";import"./vue3-manner-report-313033e6.js";import"./axios-85bcd05e.js";import"./crypto-js-43a3a23e.js";import"./cron-parser-1391a961.js";import"./luxon-b01799b6.js";import"./nprogress-c04e6182.js";import"./pinia-3f60a8e1.js";import"./sortablejs-2f5483e3.js";import"./qrcodejs2-fix-bab07f30.js";import"./moment-bafe441d.js";import"./pinyin-pro-c81f5d39.js";import"./vue-i18n-0843b5c5.js";import"./@intlify-2528d766.js";import"./source-map-b06bd4b9.js";import"./vue-c723f8b1.js";import"./pinia-plugin-persistedstate-d2bd58cf.js";import"./resize-observer-polyfill-ad543aa3.js";import"./vue-smart-widget-8b3f5b0a.js";import"./echarts-b5d24e9a.js";import"./zrender-a15b073b.js";import"./tslib-a4e99503.js";import"./echarts-liquidfill-f5c863f1.js";import"./@antv-43d380be.js";import"./ant-design-vue-2db0c9af.js";import"./@ant-design-60f2ef8e.js";import"./vue-types-6bcea8eb.js";import"./dom-align-78cb5391.js";import"./vue-draggable-next-a413f884.js";import"./vue-resize-observer-90aea344.js";const _={key:0,class:"main"},U={class:"w-100"},R={key:1,class:"del-box"},A={class:"del-title"},x={class:"del-icon"},S={class:"mt-10"},I={key:0,class:"mt-10"},z=l({__name:"Allocation",props:{idFieldName:{type:String,default:""},entityCode:{type:[String,Number],default:""}},emits:"allocationSuccess",setup(l,{expose:z,emit:C}){const F=l;e();const N=i("$ElMessage"),E=i("$API");let $=d(!1),q=d(!1),D=d([]),L=r({list:[],allocationTo:[],isAssociatedRecords:!1,associatedRecords:[],userType:1,withUpdate:!1}),G=r({type:"",label:"",pageType:"list"});const M=async e=>{e&&B()},B=async()=>{L.isAssociatedRecords=!0,q.value=!0;let e=F.entityCode,l=await E.common.queryEntityList(e,!1,"share"==G.type||"del"==G.type,!0);l&&(D.value=l.data||[]),q.value=!1},H=async()=>{if("unShare"!=G.type&&"del"!=G.type&&(!L.allocationTo||L.allocationTo.length<1))return void N.warning("请选择"+G.label+"给谁");let e;if(q.value=!0,"allocation"==G.type){let l={body:{toUser:L.allocationTo[0].id,recordIds:L.list.map((e=>e[F.idFieldName])),cascades:L.associatedRecords.map((e=>e))}};e=await a(l.body)}else if("share"==G.type){let l={body:{toUsersId:L.allocationTo.map((e=>e.id)),recordIds:L.list.map((e=>e[F.idFieldName])),cascades:L.associatedRecords.map((e=>e)),withUpdate:L.withUpdate}};e=await s(l.body)}else if("unShare"==G.type){let l={body:{toUsersId:1==L.userType?[]:L.allocationTo.map((e=>e.id)),recordIds:L.list.map((e=>e[F.idFieldName]))}};e=await t(l.body,L.userType)}else{let l={body:{recordIds:L.list.map((e=>e[F.idFieldName])),cascades:L.associatedRecords.map((e=>e))}};e=await o(l.body)}e?(e.data>0?N.success(`成功${G.label} ${e.data} 条记录`):N.success(`${G.label}成功`),C("allocationSuccess",{isDel:"del"==G.type}),$.value=!1,q.value=!1):q.value=!1};return z({openDialog:e=>{$.value=!0,L.list=[...e.list],L.allocationTo=[],L.isAssociatedRecords=!1,L.associatedRecords=[],L.userType=1,L.withUpdate=!1,G.type=e.type,G.pageType=e.pageType,"allocation"==e.type&&(G.label="分配"),"share"==e.type&&(G.label="共享"),"unShare"==e.type&&(G.label="取消共享"),"del"==e.type&&(G.label="删除")}}),(e,l)=>{const a=p("el-form-item"),s=p("mlSelectUser"),t=p("el-radio"),o=p("el-radio-group"),i=p("el-option"),d=p("el-select"),r=p("el-checkbox"),z=p("el-form"),C=p("ElIconWarnTriangleFilled"),F=p("el-icon"),N=p("el-button"),E=p("ml-dialog"),J=m("loading");return u(),c(E,{title:v(G).label,modelValue:v($),"onUpdate:modelValue":l[9]||(l[9]=e=>j($)?$.value=e:$=e),width:"560px","append-to-body":""},{footer:n((()=>[y(N,{onClick:l[8]||(l[8]=e=>j($)?$.value=!1:$=!1),loading:v(q)},{default:n((()=>[b("取消")])),_:1},8,["loading"]),y(N,{onClick:H,loading:v(q),type:"primary"},{default:n((()=>[b("确定")])),_:1},8,["loading"])])),default:n((()=>["del"!=v(G).type?f((u(),g("div",_,[y(z,{"label-width":"140px"},{default:n((()=>["list"==v(G).pageType?(u(),c(a,{key:0,label:v(G).label+"哪些记录",class:"mb-10"},{default:n((()=>[b("选中的记录（"+h(v(L).list.length)+" 条）",1)])),_:1},8,["label"])):V("",!0),"unShare"!=v(G).type?(u(),c(a,{key:1,label:v(G).label+"给谁",class:"mb-10"},{default:n((()=>["allocation"==v(G).type?(u(),c(s,{key:0,type:"User",modelValue:v(L).allocationTo,"onUpdate:modelValue":l[0]||(l[0]=e=>v(L).allocationTo=e),clearable:""},null,8,["modelValue"])):(u(),c(s,{key:1,type:"all",modelValue:v(L).allocationTo,"onUpdate:modelValue":l[1]||(l[1]=e=>v(L).allocationTo=e),multiple:"",clearable:""},null,8,["modelValue"]))])),_:1},8,["label"])):V("",!0),"unShare"==v(G).type?(u(),c(a,{key:2,label:"取消哪些用户",class:"mb-5"},{default:n((()=>[T("div",U,[y(o,{modelValue:v(L).userType,"onUpdate:modelValue":l[2]||(l[2]=e=>v(L).userType=e)},{default:n((()=>[y(t,{label:1},{default:n((()=>[b("全部用户")])),_:1}),y(t,{label:2},{default:n((()=>[b("指定用户")])),_:1})])),_:1},8,["modelValue"]),2==v(L).userType?(u(),c(s,{key:0,type:"all",modelValue:v(L).allocationTo,"onUpdate:modelValue":l[3]||(l[3]=e=>v(L).allocationTo=e),multiple:"",clearable:""},null,8,["modelValue"])):V("",!0)])])),_:1})):V("",!0),v(L).isAssociatedRecords||"unShare"==v(G).type||"dashboardList"===v(G).pageType?V("",!0):(u(),c(a,{key:3,label:" ",class:"mb-5"},{default:n((()=>[T("span",{class:"ml-a-span",onClick:B},"同时"+h(v(G).label)+"关联记录",1)])),_:1})),v(L).isAssociatedRecords?(u(),c(a,{key:4,label:"选择相关记录",class:"mb-10"},{default:n((()=>[y(d,{modelValue:v(L).associatedRecords,"onUpdate:modelValue":l[4]||(l[4]=e=>v(L).associatedRecords=e),multiple:"",filterable:"",class:"w-100","value-key":"label"},{default:n((()=>[(u(!0),g(k,null,w(v(D),(e=>(u(),c(i,{key:e.value,label:e.label,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):V("",!0),"share"==v(G).type?(u(),c(a,{key:5,label:" "},{default:n((()=>[y(r,{modelValue:v(L).withUpdate,"onUpdate:modelValue":l[5]||(l[5]=e=>v(L).withUpdate=e),label:"允许编辑 (不勾选则仅共享读取权限)"},null,8,["modelValue"])])),_:1})):V("",!0)])),_:1})])),[[J,v(q)]]):f((u(),g("div",R,[T("div",A,[T("span",x,[y(F,null,{default:n((()=>[y(C)])),_:1})]),b(" 确认删除选中的 "+h(v(L).list.length)+" 条记录？ ",1)]),T("div",S,[y(r,{onChange:M,modelValue:v(L).isAssociatedRecords,"onUpdate:modelValue":l[6]||(l[6]=e=>v(L).isAssociatedRecords=e),label:"同时删除关联记录"},null,8,["modelValue"])]),v(L).isAssociatedRecords?(u(),g("div",I,[y(d,{modelValue:v(L).associatedRecords,"onUpdate:modelValue":l[7]||(l[7]=e=>v(L).associatedRecords=e),multiple:"",filterable:"",class:"w-100","value-key":"label"},{default:n((()=>[(u(!0),g(k,null,w(v(D),(e=>(u(),c(i,{key:e.value,label:e.label,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])):V("",!0)])),[[J,v(q)]])])),_:1},8,["title","modelValue"])}}},[["__scopeId","data-v-f35e46a8"]]);export{z as default};
