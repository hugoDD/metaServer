import{_ as e,n as l,aC as a,Y as t,U as o}from"./index-ea085229.js";import{m as i}from"./index-b30b6746.js";import{R as u,r as d,p as r,v as s,l as n,Y as p,X as m,E as c,o as f,a as v,c as F,w as y,F as b,A as g,i as j,z as h,g as V,t as N,e as M,f as C,G as x,bh as w,bf as T}from"./@vue-1ad4818c.js";import"./element-plus-bab58d46.js";import"./lodash-es-b8e8104a.js";import"./@vueuse-477b4dbb.js";import"./@element-plus-2a6d398c.js";import"./@babel-6bd44fd1.js";import"./@popperjs-b78c3215.js";import"./@ctrl-4982d949.js";import"./dayjs-7fb79ad3.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./escape-html-3148dbc9.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-0ef99041.js";import"./vue3-manner-report-313033e6.js";import"./axios-85bcd05e.js";import"./crypto-js-43a3a23e.js";import"./cron-parser-1391a961.js";import"./luxon-b01799b6.js";import"./vue-router-414ebc36.js";import"./nprogress-c04e6182.js";import"./pinia-3f60a8e1.js";import"./sortablejs-2f5483e3.js";import"./qrcodejs2-fix-bab07f30.js";import"./moment-bafe441d.js";import"./pinyin-pro-c81f5d39.js";import"./vue-i18n-0843b5c5.js";import"./@intlify-2528d766.js";import"./source-map-b06bd4b9.js";import"./vue-c723f8b1.js";import"./pinia-plugin-persistedstate-d2bd58cf.js";import"./resize-observer-polyfill-ad543aa3.js";import"./vue-smart-widget-8b3f5b0a.js";import"./echarts-b5d24e9a.js";import"./zrender-a15b073b.js";import"./tslib-a4e99503.js";import"./echarts-liquidfill-f5c863f1.js";import"./@antv-43d380be.js";import"./ant-design-vue-2db0c9af.js";import"./@ant-design-60f2ef8e.js";import"./vue-types-6bcea8eb.js";import"./dom-align-78cb5391.js";import"./vue-draggable-next-a413f884.js";import"./vue-resize-observer-90aea344.js";const _=e=>(w("data-v-dfde4efc"),e=e(),T(),e),k={class:"action-div"},E={key:0,class:"w-100 mb-10"},U={class:"uptade-rule-span"},L={class:"uptade-rule-span"},R=["onClick"],Y=_((()=>V("div",{class:"w-100 info-text mt-3"},"目标字段",-1))),z=_((()=>V("div",{class:"w-100 info-text mt-3"},"更新方式",-1))),A={key:8,class:"w-100 info-text mt-3"},D={key:0},I=e({__name:"fieldUpdate",props:{modelValue:null},setup(e){const w=e,T=u("$API"),_=u("$ElMessage");let I=d(!1),O=d({});r((()=>{O.value=w.modelValue,J()}));let B=d([]),P=d([]),$=d({}),S=d([]),q=d({}),G=d(!1),H=d(!1);const J=async()=>{I.value=!0;let{value:e}=O.value.actionType;1!=e&&2!=e||Promise.all([K(),X()]).then((()=>{if(I.value=!1,B.value.length>0){let e=0;if(O.value.isOnSave){let{actionContent:l}=O.value;B.value.forEach(((a,t)=>{a.fieldName==l.fieldName&&a.entityName==l.entityName&&(e=t)}))}O.value.defaultTargetEntity=B.value[e],Z(B.value[e].entityCode)}}))},K=()=>new Promise((async(e,l)=>{let a=await T.trigger.detial.dataUpdateEntityList(O.value.entityCode);a&&(B.value=a.data.map(((e,l)=>(e.entityInx=l,e))),a.data.forEach((e=>{$.value[e.fieldName]=e.fieldLabel}))),e()})),X=()=>new Promise((async(e,a)=>{let t=await l(O.value.entityCode,!0,!0);t&&(S.value=t.data||[],t.data.forEach((e=>{q.value[e.fieldName]=e.fieldLabel}))),e()})),Z=async e=>{var a;G.value=!0;let t=await l(e,!1,!1,!0);t&&(P.value=t.data,P.value&&P.value.length>0&&t.data.length>0&&(Q.value=t.data[0],W.targetField=t.data[0].fieldName,ae.value=he(t.data[0].fieldName),"Reference"==ae.value&&(W.updateMode="forField",W.sourceField={}),"Option"==ae.value&&(W.updateMode="toFixed",W.sourceField=""),"Tag"==ae.value&&(W.updateMode="toFixed",W.sourceField=[]),"forField"==W.updateMode&&(W.sourceField=null==(a=Ve()[0])?void 0:a.fieldName),ce())),G.value=!1};let Q=d({}),W=s({targetField:"",updateMode:"forField",sourceField:"",simpleFormula:!1}),ee=d([{label:"字段值",value:"forField"},{label:"固定值",value:"toFixed"},{label:"置空",value:"toNull"},{label:"计算公式",value:"forCompile"}]);const le=s({forField:"字段值",toFixed:"固定值",toNull:"置空",forCompile:"计算公式"});let ae=d("");let te=d([]),oe=d(!1);const ie=async e=>{var l;if(W.targetField=e.fieldName,ae.value=he(e.fieldName),"forField"==W.updateMode?W.sourceField=null==(l=Ve()[0])?void 0:l.fieldName:W.sourceField="","Tag"==e.fieldType||"Option"==e.fieldType){oe.value=!0;let l,a=O.value.defaultTargetEntity.entityName,i=e.fieldName;"Tag"==e.fieldType?(l=await t(a,i),W.updateMode="toFixed",W.sourceField=[]):(l=await o(a,i),W.updateMode="toFixed",W.sourceField={}),l&&l.data&&(te.value=l.data),oe.value=!1}},ue=e=>{var l;"forField"==e.value?W.sourceField=null==(l=Ve()[0])?void 0:l.fieldName:"Reference"==ae.value||"Option"==ae.value?W.sourceField={}:"Tag"==ae.value?W.sourceField=[]:W.sourceField=null};let de=d([]);const re=()=>{let{targetField:e,updateMode:l,sourceField:a,simpleFormula:t}=W;if(e&&("toNull"==l||a))if(O.value.actionContent.fieldName+"."+e!=a)if("mobilePhone"!=e||"toFixed"!=l||11==a.length&&!isNaN(a))if(O.value.actionContent.items.filter((l=>l.targetField==e)).length>0)_.warning("目标字段重复!");else{if("toNull"==l){let l=P.value.filter((l=>l.fieldName==e));if(!l[0].isNullable)return void _.warning("目标字段 [ "+l[0].fieldLabel+" ] 不能为空!")}O.value.actionContent.items.push({targetField:e,updateMode:l,sourceField:a,simpleFormula:t}),de.value.push({targetField:se(e),updateMode:ne(l),sourceField:pe(W),simpleFormula:t}),"forField"!=l&&(W.sourceField="")}else _.warning("手机号格式不正确!");else _.warning("目标字段与源字段不能为同一字段!")},se=e=>$.value[e],ne=e=>le[e],pe=e=>"forCompile"==e.updateMode?e.simpleFormula?e.sourceField:me(e.sourceField):q.value[e.sourceField],me=e=>{let l=e,a=l.match(/{([a-zA-Z0-9$\.]+)}/g);return a?(a.forEach((e=>{let a=e.substring(1);a=a.substring(0,a.length-1);let t=a.split("$");l=l.replace(e,`{${q.value[t[0]]}(${le[t[1]]})`)})),l):l},ce=()=>{de.value=[],O.value.actionContent.items.forEach((e=>{de.value.push({targetField:se(e.targetField),calcMode:ne(e.calcMode),sourceField:pe(e),simpleFormula:e.simpleFormula})}))};let fe=d(!1),ve=d([]),Fe=d("");d(["Integer","Decimal","Percent","Money"]);let ye=d(!1);const be=()=>{ge(S.value,!0,W.sourceField)},ge=(e,l,a)=>{fe.value=!0,ve.value=e,ye.value=l,Fe.value=l?a:"",W.simpleFormula=l},je=e=>{W.sourceField=e.label},he=e=>P.value.filter((l=>l.fieldName==e))[0].fieldType,Ve=()=>{let{fieldType:e,referenceName:l}=Q.value;if(["Email","Url","TextArea","Text"].includes(e))return S.value.filter((e=>"Reference"!=e.fieldType));if("Reference"==e){let a=[];return S.value.forEach((t=>{t.fieldType==e&&t.referenceName==l&&a.push(t)})),a}{let l=[];return S.value.forEach((a=>{a.fieldType!=e&&"Text"!=a.fieldType||l.push(a)})),l.length<1?S.value.filter((e=>"Reference"!=e.fieldType)):l}},Ne=e=>{var l;return(null==(l=P.value.filter((l=>l.fieldName==e))[0])?void 0:l.fieldLabel)||"（该字段已删除）"},Me=e=>{var l;return null==(l=ee.value.filter((l=>l.value==e))[0])?void 0:l.label},Ce=e=>{var l,a;if("forField"!==e.updateMode){if(1==e.sourceField&&"Boolean"==ae.value)return"正常";if(0==e.sourceField&&"Boolean"==ae.value)return"禁用";if(e.sourceField&&e.sourceField.label)return e.sourceField.label;if(e.sourceField&&Array.isArray(e.sourceField)){return(e.sourceField.map((e=>e.label))||[]).join()}return e.sourceField}return null==(a=(null==(l=S.value)?void 0:l.filter((l=>l.fieldName==e.sourceField)))[0])?void 0:a.fieldLabel},xe=()=>{let e=O.value.defaultTargetEntity;O.value.actionContent.entityName=e.entityName,O.value.actionContent.fieldName=e.fieldName,O.value.actionContent.N=e.N,O.value.actionContent.items=[],e.entityCode?Z(e.entityCode):(P.value=S.value,Q.value=P.value[0])},we=e=>{W.sourceField=e,H.value=!1};return(e,l)=>{const t=n("el-option"),o=n("el-select"),u=n("el-col"),d=n("el-row"),r=n("el-form-item"),s=n("ElIconCloseBold"),w=n("el-icon"),T=n("el-date-picker"),_=n("el-input"),$=n("ElIconSearch"),S=n("el-button"),q=n("el-dialog"),J=p("loading");return m((f(),v("div",k,[F(r,{label:"目标实体"},{default:y((()=>[F(d,{class:"w-100 mb-15",gutter:20},{default:y((()=>[F(u,{span:9},{default:y((()=>[F(o,{modelValue:c(O).defaultTargetEntity,"onUpdate:modelValue":l[0]||(l[0]=e=>c(O).defaultTargetEntity=e),filterable:"",class:"w-100",onChange:xe,disabled:c(O).isOnSave,"value-key":"entityInx"},{default:y((()=>[(f(!0),v(b,null,g(c(B),((e,l)=>(f(),j(t,{key:l,label:e.label,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})])),_:1})])),_:1}),F(r,null,{label:y((()=>[h("更新规则")])),default:y((()=>{var e,a;return[(null==(a=null==(e=c(O).actionContent)?void 0:e.items)?void 0:a.length)>0?(f(),v("div",E,[(f(!0),v(b,null,g(c(O).actionContent.items,((e,l)=>(f(),j(d,{gutter:20,class:"uptade-rule-row w-100 mb-5",key:l},{default:y((()=>[F(u,{span:9},{default:y((()=>[V("span",U,N(Ne(e.targetField)),1)])),_:2},1024),F(u,{span:5},{default:y((()=>[V("span",L,N(Me(e.updateMode)),1)])),_:2},1024),F(u,{span:9,class:"uptade-rule-col-last"},{default:y((()=>[V("span",{class:M(["uptade-rule-span",{toFixed:"toFixed"==e.updateMode,forCompile:"forCompile"==e.updateMode,toNull:"toNull"==e.updateMode}])},[h(N(Ce(e))+" ",1),V("span",{class:"del-icon",onClick:e=>(e=>{O.value.actionContent.items.splice(e,1),de.value.splice(e,1)})(l)},[F(w,null,{default:y((()=>[F(s)])),_:1})],8,R)],2)])),_:2},1024)])),_:2},1024)))),128))])):C("",!0),m((f(),j(d,{class:"w-100 mb-10 uptade-rule",gutter:20},{default:y((()=>[F(u,{span:9},{default:y((()=>[F(o,{modelValue:c(Q),"onUpdate:modelValue":l[1]||(l[1]=e=>x(Q)?Q.value=e:Q=e),filterable:"",class:"w-100",onChange:ie,"value-key":"fieldLabel"},{default:y((()=>[(f(!0),v(b,null,g(c(P),((e,l)=>(f(),j(t,{key:l,label:e.fieldLabel,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),Y])),_:1}),F(u,{span:5},{default:y((()=>[F(o,{modelValue:c(W).updateMode,"onUpdate:modelValue":l[2]||(l[2]=e=>c(W).updateMode=e),class:"w-100",onChange:ue},{default:y((()=>[(f(!0),v(b,null,g("Reference"==ae.value||"Option"==ae.value||"Tag"==ae.value?[{label:"字段值",value:"forField"},{label:"固定值",value:"toFixed"},{label:"置空",value:"toNull"}]:ee.value,((e,l)=>(f(),j(t,{key:l,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),z])),_:1}),F(u,{span:9},{default:y((()=>["forField"==c(W).updateMode?(f(),j(o,{key:0,modelValue:c(W).sourceField,"onUpdate:modelValue":l[3]||(l[3]=e=>c(W).sourceField=e),filterable:"",class:"w-100"},{default:y((()=>[(f(!0),v(b,null,g(Ve(),((e,l)=>(f(),j(t,{key:l,label:e.fieldLabel,value:e.fieldName},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])):C("",!0),"toFixed"==c(W).updateMode&&"Boolean"==c(ae)?(f(),j(o,{key:1,modelValue:c(W).sourceField,"onUpdate:modelValue":l[4]||(l[4]=e=>c(W).sourceField=e),filterable:"",class:"w-100"},{default:y((()=>[F(t,{label:"正常",value:"1"}),F(t,{label:"禁用",value:"0"})])),_:1},8,["modelValue"])):C("",!0),"toFixed"!=c(W).updateMode||"DateTime"!=c(ae)&&"Time"!=c(ae)?C("",!0):(f(),j(T,{key:2,modelValue:c(W).sourceField,"onUpdate:modelValue":l[5]||(l[5]=e=>c(W).sourceField=e),format:"YYYY/MM/DD hh:mm:ss","value-format":"YYYY-MM-DD hh:mm:ss a",type:"datetime"},null,8,["modelValue"])),"toFixed"==c(W).updateMode&&"Reference"!=c(ae)&&"Tag"!=c(ae)&&"Option"!=c(ae)&&"Boolean"!=c(ae)&&"DateTime"!=c(ae)&&"Time"!=c(ae)?(f(),j(_,{key:3,modelValue:c(W).sourceField,"onUpdate:modelValue":l[6]||(l[6]=e=>c(W).sourceField=e),placeholder:"固定值"},null,8,["modelValue"])):C("",!0),"toFixed"==c(W).updateMode&&"Reference"==c(ae)?(f(),j(_,{key:4,modelValue:c(W).sourceField.label,"onUpdate:modelValue":l[8]||(l[8]=e=>c(W).sourceField.label=e),placeholder:"固定值"},{append:y((()=>[F(S,{onClick:l[7]||(l[7]=e=>x(H)?H.value=!0:H=!0)},{default:y((()=>[F(w,null,{default:y((()=>[F($)])),_:1})])),_:1})])),_:1},8,["modelValue"])):C("",!0),"toFixed"==c(W).updateMode&&"Option"==c(ae)?m((f(),j(o,{key:5,modelValue:c(W).sourceField,"onUpdate:modelValue":l[9]||(l[9]=e=>c(W).sourceField=e),filterable:"",class:"w-100"},{default:y((()=>[(f(!0),v(b,null,g(c(te),((e,l)=>(f(),j(t,{key:l,label:e.label,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])),[[J,c(oe)]]):C("",!0),"toFixed"==c(W).updateMode&&"Tag"==c(ae)?m((f(),j(o,{key:6,modelValue:c(W).sourceField,"onUpdate:modelValue":l[10]||(l[10]=e=>c(W).sourceField=e),filterable:"",class:"w-100",multiple:""},{default:y((()=>[(f(!0),v(b,null,g(c(te),((e,l)=>(f(),j(t,{key:l,label:e.label,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])),[[J,c(oe)]]):C("",!0),"forCompile"==c(W).updateMode?(f(),j(_,{key:7,modelValue:c(W).sourceField,"onUpdate:modelValue":l[11]||(l[11]=e=>c(W).sourceField=e),placeholder:"计算公式",autosize:"",type:"textarea",onClick:be},null,8,["modelValue"])):C("",!0),"toNull"!==c(W).updateMode?(f(),v("div",A,N("forField"==W.updateMode?"源字段":"toFixed"==W.updateMode?"固定值":"forCompile"==W.updateMode?"计算公式":void 0),1)):C("",!0)])),_:1})])),_:1})),[[J,c(G)]])]})),_:1}),F(r,{label:" "},{default:y((()=>[F(S,{type:"primary",plain:"",onClick:re},{default:y((()=>[h("+ 添加")])),_:1})])),_:1}),c(fe)?(f(),v("div",D,[F(i,{modelValue:c(fe),"onUpdate:modelValue":l[12]||(l[12]=e=>x(fe)?fe.value=e:fe=e),fields:c(ve),defaultFormulaVal:c(Fe),isAdvanced:c(ye),onConfirm:je},null,8,["modelValue","fields","defaultFormulaVal","isAdvanced"])])):C("",!0),c(H)?(f(),j(q,{key:1,title:"请选择",modelValue:c(H),"onUpdate:modelValue":l[13]||(l[13]=e=>x(H)?H.value=e:H=e),"show-close":!0,class:"small-padding-dialog",width:"520px",draggable:"","close-on-click-modal":!1,"close-on-press-escape":!1,"append-to-body":!0},{default:y((()=>[F(a,{ref:"referST",entity:c(O).defaultTargetEntity.entityName,refField:c(W).targetField,onRecordSelected:we},null,8,["entity","refField"])])),_:1},8,["modelValue"])):C("",!0)])),[[J,c(I)]])}}},[["__scopeId","data-v-dfde4efc"]]);export{I as default};
